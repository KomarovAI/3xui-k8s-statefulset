apiVersion: batch/v1
kind: CronJob
metadata:
  name: xui-selfbackup
  namespace: xui-vpn
spec:
  schedule: "0 3 * * *"  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: xui-selfbackup
        spec:
          restartPolicy: OnFailure
          volumes:
            - name: xui-data
              persistentVolumeClaim:
                claimName: xui-data-pvc
          containers:
            - name: backup-and-push
              image: alpine/git:latest
              volumeMounts:
                - mountPath: /backup
                  name: xui-data
              env:
                - name: GITHUB_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: github-backup-secret
                      key: token
                - name: GITHUB_REPO
                  value: "KomarovAI/3xui-k8s-statefulset"
                - name: GITHUB_USER
                  value: "KomarovAI"
                - name: GITHUB_EMAIL
                  value: "artur.komarovv@gmail.com"
              resources:
                limits:
                  memory: 128Mi
                  cpu: 200m
                requests:
                  memory: 64Mi
                  cpu: 50m
              command:
                - sh
                - -c
                - |
                  set -e
                  apk add --no-cache bash tar gzip
                  # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –∏–∑ PVC
                  find /backup -name 'xui-backup-*.tar.gz' -mtime +7 -delete
                  # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–æ–≤ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                  BACKUP_FILE="xui-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
                  tar --use-compress-program="gzip -1" \
                      -cf "/backup/$BACKUP_FILE" \
                      -C /backup \
                      x-ui.db config.json cert/ \
                      --exclude='*.log' --exclude='access.log' --exclude='error.log' || echo 'Some files missing, check volume!'
                  echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE"
                  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ repo –¥–ª—è push
                  git config --global user.name "$GITHUB_USER"
                  git config --global user.email "$GITHUB_EMAIL"
                  git config --global credential.helper store
                  REPO_URL="https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
                  WORK_DIR="/tmp/backups"
                  # clone or init backups branch
                  if git clone --depth 1 --branch backups "$REPO_URL" "$WORK_DIR" 2>/dev/null; then
                    cd "$WORK_DIR"
                  else
                    git clone --depth 1 "$REPO_URL" "$WORK_DIR"
                    cd "$WORK_DIR"
                    git checkout --orphan backups
                    git rm -rf .
                    echo "# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã 3X-UI Panel" > README.md
                    echo "" >> README.md
                    echo "–ë—ç–∫–∞–ø—ã: —Ç–æ–ª—å–∫–æ x-ui.db, config.json, cert/ (SSL)" >> README.md
                    git add README.md
                    git commit -m "init: —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ backups"
                    git push origin backups
                  fi
                  # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–æ–≤ –≤ repo
                  cp "/backup/$BACKUP_FILE" "$WORK_DIR/"
                  ls -t xui-backup-*.tar.gz 2>/dev/null | tail -n +31 | xargs -r rm -f
                  git add .
                  if git diff-index --quiet HEAD --; then
                    echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
                  else
                    BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                    git commit -m "backup: $BACKUP_FILE ($BACKUP_SIZE)"
                    git push origin backups
                    echo "‚úÖ GitHub backup push done"
                  fi
                  echo "üéâ K8s CronJob repo backup complete!"
