apiVersion: batch/v1
kind: CronJob
metadata:
  name: xui-selfbackup
  namespace: xui-vpn
spec:
  schedule: "0 3 * * *"  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: xui-selfbackup
        spec:
          restartPolicy: OnFailure
          volumes:
            - name: xui-data
              persistentVolumeClaim:
                claimName: xui-data-pvc
          containers:
            - name: backup-and-push
              image: alpine/git:latest
              volumeMounts:
                - mountPath: /backup
                  name: xui-data
              env:
                - name: GITHUB_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: github-backup-secret
                      key: token
                - name: GITHUB_REPO
                  value: "KomarovAI/3xui-k8s-statefulset"
                - name: GITHUB_USER
                  value: "KomarovAI"
                - name: GITHUB_EMAIL
                  value: "artur.komarovv@gmail.com"
              resources:
                limits:
                  memory: 128Mi
                  cpu: 200m
                requests:
                  memory: 64Mi
                  cpu: 50m
              command:
                - sh
                - -c
                - |
                  set -e
                  
                  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
                  apk add --no-cache bash tar gzip
                  
                  # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
                  echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π..."
                  find /backup -name 'xui-backup-*.tar.gz' -mtime +7 -delete
                  
                  # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±—ç–∫–∞–ø–∞
                  BACKUP_FILE="xui-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
                  echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞: $BACKUP_FILE"
                  tar --use-compress-program="gzip -1" \
                      -cf "/backup/$BACKUP_FILE" \
                      -C /backup . \
                      --exclude='xui-backup-*.tar.gz' \
                      --exclude='.git'
                  
                  echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $(du -h /backup/$BACKUP_FILE | cut -f1)"
                  
                  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git
                  git config --global user.name "$GITHUB_USER"
                  git config --global user.email "$GITHUB_EMAIL"
                  git config --global credential.helper store
                  
                  # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ backups (–∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π)
                  REPO_URL="https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
                  WORK_DIR="/tmp/backups"
                  
                  echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
                  if git clone --depth 1 --branch backups "$REPO_URL" "$WORK_DIR" 2>/dev/null; then
                    echo "‚úÖ –í–µ—Ç–∫–∞ backups —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                    cd "$WORK_DIR"
                  else
                    echo "üî® –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ç–∫–∏ backups..."
                    git clone --depth 1 "$REPO_URL" "$WORK_DIR"
                    cd "$WORK_DIR"
                    git checkout --orphan backups
                    git rm -rf .
                    echo "# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã 3X-UI Panel" > README.md
                    echo "" >> README.md
                    echo "–ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC" >> README.md
                    echo "–•—Ä–∞–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –±—ç–∫–∞–ø–æ–≤" >> README.md
                    git add README.md
                    git commit -m "init: —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ backups"
                    git push origin backups
                  fi
                  
                  # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
                  echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
                  cp "/backup/$BACKUP_FILE" "$WORK_DIR/"
                  
                  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±—ç–∫–∞–ø–æ–≤ –≤ —Ä–µ–ø–æ (—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30)
                  echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –≤ —Ä–µ–ø–æ (—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30)..."
                  cd "$WORK_DIR"
                  ls -t xui-backup-*.tar.gz 2>/dev/null | tail -n +31 | xargs -r rm -f
                  
                  # –ö–æ–º–º–∏—Ç –∏ push
                  git add .
                  if git diff-index --quiet HEAD --; then
                    echo "‚ÑπÔ∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
                  else
                    BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                    git commit -m "backup: $BACKUP_FILE ($BACKUP_SIZE)"
                    echo "‚¨ÜÔ∏è  Push –≤ GitHub..."
                    git push origin backups
                    echo "‚úÖ –ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ GitHub!"
                  fi
                  
                  echo "üéâ –ì–æ—Ç–æ–≤–æ!"
