name: Full Security & K8s Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: test-image:local
  TRIVY_VERSION: 0.50.2
  DOCKLE_VERSION: 0.4.15
  GRYPE_VERSION: 0.75.0
  SYFT_VERSION: 1.4.0
  POLARIS_VERSION: 8.5.0
  KUBECONFORM_VERSION: 0.6.4
  CONFTEST_VERSION: 0.49.0
  HADOLINT_VERSION: 2.12.0
  DIVE_VERSION: 0.12.0
  KUBESCORE_VERSION: 1.18.0

jobs:
  build-image:
    name: 'Build Docker Image (single source)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image for all image jobs
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      - name: Save Docker image as artifact
        run: |
          docker save ${{ env.IMAGE_NAME }} | gzip > image.tar.gz
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar.gz

  hadolint-lint:
    name: 'Hadolint - Dockerfile Optimization'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Hadolint
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v${{ env.HADOLINT_VERSION }}/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      - name: Run Hadolint
        run: |
          hadolint Dockerfile > hadolint.log
      - name: Upload Hadolint RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-hadolint
          path: hadolint.log

  dive-analysis:
    name: 'Dive - Image Efficiency Analysis'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      - name: Install Dive
        run: |
          wget https://github.com/wagoodman/dive/releases/download/v${{ env.DIVE_VERSION }}/dive_${{ env.DIVE_VERSION }}_linux_amd64.tar.gz
          tar -xzf dive_${{ env.DIVE_VERSION }}_linux_amd64.tar.gz
          sudo mv dive /usr/local/bin/
      - name: Run Dive analysis
        run: |
          CI=true dive ${{ env.IMAGE_NAME }} --ci --json dive-report.json > dive.log || true
      - name: Upload Dive RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-dive
          path: dive.log

  kube-score:
    name: 'Kube-Score - Advanced K8s Readiness'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install kube-score
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v${{ env.KUBESCORE_VERSION }}/kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          tar -xzf kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/
      - name: Run kube-score
        run: |
          if [ -d "manifests" ]; then
            kube-score score manifests/*.yaml --output-format ci > kube-score.log || true
          else
            echo 'Нет manifests/ для анализа' > kube-score.log
          fi
      - name: Upload Kube-Score RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-kubescore
          path: kube-score.log

# (Сохранение raw логов для всех security/sca/policy job'ов ниже)
  trivy-scan:
    name: 'Trivy - Vulnerability Scan (Dockerfile)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Trivy
        run: |
          sudo apt-get update && sudo apt-get install -y wget
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${{ env.TRIVY_VERSION }}/trivy_${{ env.TRIVY_VERSION }}_Linux-64bit.tar.gz | tar xz
          sudo mv trivy /usr/local/bin/
      - name: Run Trivy on Dockerfile
        run: |
          trivy config Dockerfile > trivy.log
      - name: Upload Trivy RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-trivy
          path: trivy.log

  dockle-scan:
    name: 'Dockle - Docker Image Linter'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Dockle
        run: |
          wget -O - https://github.com/goodwithtech/dockle/releases/download/v${{ env.DOCKLE_VERSION }}/dockle_${{ env.DOCKLE_VERSION }}_Linux-64bit.tar.gz | tar xz
          sudo mv dockle /usr/local/bin/
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      - name: Load Docker image
        run: |
          gunzip -c image.tar.gz | docker load
      - name: Run Dockle
        run: |
          dockle ${{ env.IMAGE_NAME }} > dockle.log
      - name: Upload Dockle RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-dockle
          path: dockle.log

  grype-scan:
    name: 'Grype - Container Vulnerability Scan'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Grype
        run: |
          wget -O- https://github.com/anchore/grype/releases/download/v${{ env.GRYPE_VERSION }}/grype_${{ env.GRYPE_VERSION }}_linux_amd64.tar.gz | tar xz
          sudo mv grype /usr/local/bin/
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      - name: Load Docker image
        run: |
          gunzip -c image.tar.gz | docker load
      - name: Run Grype
        run: |
          grype ${{ env.IMAGE_NAME }} > grype.log
      - name: Upload Grype RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-grype
          path: grype.log

  syft-sbom:
    name: 'Syft - Generate SBOM'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Syft
        run: |
          wget -O- https://github.com/anchore/syft/releases/download/v${{ env.SYFT_VERSION }}/syft_${{ env.SYFT_VERSION }}_linux_amd64.tar.gz | tar xz
          sudo mv syft /usr/local/bin/
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      - name: Load Docker image
        run: |
          gunzip -c image.tar.gz | docker load
      - name: Generate SBOM (spdx-json)
        run: syft ${{ env.IMAGE_NAME }} -o spdx-json > syft.log
      - name: Upload Syft RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-syft
          path: syft.log

  polaris-score:
    name: 'Polaris - K8s Policy Enforcement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Polaris CLI
        run: |
          wget -O- https://github.com/FairwindsOps/polaris/releases/download/${{ env.POLARIS_VERSION }}/polaris_linux_amd64.tar.gz | tar xz
          sudo mv polaris /usr/local/bin/
      - name: Run Polaris Score on manifests
        run: |
          if [ -d "manifests" ]; then
            polaris audit --audit-path manifests --set-exit-code-on-error true > polaris.log
          else
            echo 'Нет manifests/ для анализа' > polaris.log
          fi
      - name: Upload Polaris RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-polaris
          path: polaris.log

  kubeconform-validate:
    name: 'kubeconform - YAML Schema Validation'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v${{ env.KUBECONFORM_VERSION }}/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          chmod +x kubeconform
          sudo mv kubeconform /usr/local/bin/
      - name: Validate K8s manifests
        run: |
          if [ -d "manifests" ]; then
            kubeconform -strict -summary manifests/*.yaml > kubeconform.log
          else
            echo 'Нет manifests/ для анализа' > kubeconform.log
          fi
      - name: Upload Kubeconform RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-kubeconform
          path: kubeconform.log

  conftest-policy:
    name: 'Conftest - OPA Policy Check'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          tar -xzf conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
      - name: Run conftest on K8s manifests (if policies exist)
        run: |
          if [ -d "policies" ] && [ -d "manifests" ]; then
            conftest test manifests/*.yaml > conftest.log
          else
            echo 'Нет policies/ или manifests/ для анализа' > conftest.log
          fi
      - name: Upload Conftest RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-conftest
          path: conftest.log

  summary:
    name: 'Workflow Final Status (RAW Aggregated)'
    needs: [hadolint-lint, dive-analysis, kube-score, trivy-scan, dockle-scan, grype-scan, syft-sbom, polaris-score, kubeconform-validate, conftest-policy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all raw logs
        uses: actions/download-artifact@v4
      - name: Aggregate all RAW logs
        run: |
          cat raw-*/** > security-full-raw.txt
      - name: Upload unified RAW security report
        uses: actions/upload-artifact@v4
        with:
          name: security-full-raw
          path: security-full-raw.txt
      - name: Show overall status
        run: |
          echo "# Финальный статус всех job'ов:" >> $GITHUB_STEP_SUMMARY
          code=0
          for job in "hadolint-lint" "dive-analysis" "kube-score" "trivy-scan" "dockle-scan" "grype-scan" "syft-sbom" "polaris-score" "kubeconform-validate" "conftest-policy"; do
            status="${{ needs[job].result }}"
            if [[ "$status" == "success" ]]; then
              echo "✅ $job: успешно" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ $job: провал" >> $GITHUB_STEP_SUMMARY
              code=1
            fi
          done
          if [[ $code -ne 0 ]]; then exit 1; else exit 0; fi
