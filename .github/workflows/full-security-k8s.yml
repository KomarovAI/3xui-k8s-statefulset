name: Full Security & K8s Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: test-image:local
  TRIVY_VERSION: 0.50.2
  DOCKLE_VERSION: 0.4.15
  GRYPE_VERSION: 0.75.0
  SYFT_VERSION: 1.4.0
  POLARIS_VERSION: 8.5.0
  KUBECONFORM_VERSION: 0.6.4
  CONFTEST_VERSION: 0.49.0
  HADOLINT_VERSION: 2.12.0
  DIVE_VERSION: 0.12.0
  KUBESCORE_VERSION: 1.18.0

jobs:
  build-image:
    name: 'Build Docker Image (single source)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image for all image jobs
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      - name: Save Docker image as artifact
        run: |
          docker save ${{ env.IMAGE_NAME }} | gzip > image.tar.gz
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar.gz

  hadolint-lint:
    name: 'Hadolint - Dockerfile Optimization'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Hadolint
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v${{ env.HADOLINT_VERSION }}/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      - name: Run Hadolint
        run: |
          hadolint Dockerfile > hadolint.log
          echo '## Hadolint Dockerfile Lint' >> $GITHUB_STEP_SUMMARY
          if grep -qiE 'DL' hadolint.log; then
            cat hadolint.log >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo 'Нет замечаний по Dockerfile' >> $GITHUB_STEP_SUMMARY
          fi

  dive-analysis:
    name: 'Dive - Image Efficiency Analysis'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      - name: Install Dive
        run: |
          wget https://github.com/wagoodman/dive/releases/download/v${{ env.DIVE_VERSION }}/dive_${{ env.DIVE_VERSION }}_linux_amd64.tar.gz
          tar -xzf dive_${{ env.DIVE_VERSION }}_linux_amd64.tar.gz
          sudo mv dive /usr/local/bin/
      - name: Run Dive analysis
        run: |
          CI=true dive ${{ env.IMAGE_NAME }} --ci --json dive-report.json > dive.log || true
          echo '## Dive Image Efficiency Report' >> $GITHUB_STEP_SUMMARY
          tail -n 60 dive.log >> $GITHUB_STEP_SUMMARY
          if grep -q 'Inefficient' dive.log; then exit 1; fi
          # Можно парсить JSON dive-report.json для automation

  kube-score:
    name: 'Kube-Score - Advanced K8s Readiness'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install kube-score
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v${{ env.KUBESCORE_VERSION }}/kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          tar -xzf kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/
      - name: Run kube-score
        run: |
          if [ -d "manifests" ]; then
            kube-score score manifests/*.yaml --output-format ci > kube-score.log || true
            echo '## Kube-Score Production Readiness' >> $GITHUB_STEP_SUMMARY
            tail -n 100 kube-score.log >> $GITHUB_STEP_SUMMARY
            if grep -q 'critical' kube-score.log; then exit 1; fi
          else
            echo 'Нет manifests/ для анализа' >> $GITHUB_STEP_SUMMARY
          fi

# (Все существующие security/sca/policy job'ы — как раньше)
# ... (оставьте все остальные job'ы БЕЗ изменений)

  summary:
    name: 'Workflow Final Status'
    needs: [hadolint-lint, dive-analysis, kube-score, trivy-scan, dockle-scan, grype-scan, syft-sbom, polaris-score, kubeconform-validate, conftest-policy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Show overall status
        run: |
          echo "# Финальный статус всех job'ов:" >> $GITHUB_STEP_SUMMARY
          code=0
          for job in "hadolint-lint" "dive-analysis" "kube-score" "trivy-scan" "dockle-scan" "grype-scan" "syft-sbom" "polaris-score" "kubeconform-validate" "conftest-policy"; do
            status="${{ needs[job].result }}"
            if [[ "$status" == "success" ]]; then
              echo "✅ $job: успешно" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ $job: провал" >> $GITHUB_STEP_SUMMARY
              code=1
            fi
          done
          if [[ $code -ne 0 ]]; then exit 1; else exit 0; fi
