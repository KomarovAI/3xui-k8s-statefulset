name: Full Security & K8s Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: test-image:local

jobs:
  build-image:
    name: 'Build Docker Image (single source)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image for all image jobs
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .

  trivy-scan:
    name: 'Trivy - Vulnerability Scan (Dockerfile)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy on Dockerfile
        run: |
          trivy config Dockerfile > trivy.log || true
          echo '## Trivy Vulnerability Report' >> $GITHUB_STEP_SUMMARY
          grep -iE 'CRITICAL|HIGH|ERROR|FAIL|DENY' trivy.log >> $GITHUB_STEP_SUMMARY || echo 'Нет уязвимостей' >> $GITHUB_STEP_SUMMARY

  dockle-scan:
    name: 'Dockle - Docker Image Linter'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Dockle
        run: |
          dockle ${{ env.IMAGE_NAME }} > dockle.log || true
          echo '## Dockle Security Output' >> $GITHUB_STEP_SUMMARY
          grep -iE 'FAIL|WARN|ERROR|DENY' dockle.log >> $GITHUB_STEP_SUMMARY || echo 'Нет ошибок' >> $GITHUB_STEP_SUMMARY

  grype-scan:
    name: 'Grype - Container Vulnerability Scan'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Grype
        run: |
          grype ${{ env.IMAGE_NAME }} > grype.log || true
          echo '## Grype CVE Report' >> $GITHUB_STEP_SUMMARY
          grep -iE 'CRITICAL|HIGH|ERROR|FAIL|DENY' grype.log >> $GITHUB_STEP_SUMMARY || echo 'Нет уязвимостей' >> $GITHUB_STEP_SUMMARY

  syft-sbom:
    name: 'Syft - Generate SBOM'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (spdx-json)
        run: syft ${{ env.IMAGE_NAME }} -o spdx-json > /dev/null
      - name: Add SBOM note
        run: echo 'SBOM создан (файл не включен в summary, смотри artifacts если нужно)' >> $GITHUB_STEP_SUMMARY

  polaris-score:
    name: 'Polaris - K8s Policy Enforcement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Polaris CLI
        run: |
          curl -sSL https://github.com/FairwindsOps/polaris/releases/download/8.5.0/polaris_linux_amd64.tar.gz | tar xz
          sudo mv polaris /usr/local/bin/
      - name: Run Polaris Score on manifests
        run: |
          if [ -d "manifests" ]; then
            polaris audit --audit-path manifests --set-exit-code-on-error true > polaris.log || true
            echo '## Polaris Audit Output' >> $GITHUB_STEP_SUMMARY
            grep -iE 'FAIL|ERROR|DENY|WARN' polaris.log >> $GITHUB_STEP_SUMMARY || echo 'Нет ошибок' >> $GITHUB_STEP_SUMMARY
          else
            echo 'Нет manifests/ для анализа' >> $GITHUB_STEP_SUMMARY
          fi

  kubeconform-validate:
    name: 'kubeconform - YAML Schema Validation'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          chmod +x kubeconform
          sudo mv kubeconform /usr/local/bin/
      - name: Validate K8s manifests
        run: |
          if [ -d "manifests" ]; then
            kubeconform -strict -summary manifests/*.yaml > kubeconform.log || true
            echo '## Kubeconform Validation Output' >> $GITHUB_STEP_SUMMARY
            grep -iE 'FAIL|ERROR|DENY|WARN' kubeconform.log >> $GITHUB_STEP_SUMMARY || echo 'Нет ошибок' >> $GITHUB_STEP_SUMMARY
          else
            echo 'Нет manifests/ для анализа' >> $GITHUB_STEP_SUMMARY
          fi

  conftest-policy:
    name: 'Conftest - OPA Policy Check'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.0/conftest_0.49.0_Linux_x86_64.tar.gz
          tar -xzf conftest_0.49.0_Linux_x86_64.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
      - name: Run conftest on K8s manifests (if policies exist)
        run: |
          if [ -d "policies" ] && [ -d "manifests" ]; then
            conftest test manifests/*.yaml > conftest.log || true
            echo '## OPA Policy Error Report' >> $GITHUB_STEP_SUMMARY
            grep -iE 'FAIL|DENY|ERROR|WARN' conftest.log >> $GITHUB_STEP_SUMMARY || echo 'Нет ошибок' >> $GITHUB_STEP_SUMMARY
          else
            echo 'Нет policies/ или manifests/ для анализа' >> $GITHUB_STEP_SUMMARY
          fi
