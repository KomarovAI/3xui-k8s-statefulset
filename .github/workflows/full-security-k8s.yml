name: Full Security & K8s Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: test-image:local

jobs:
  build-image:
    name: 'Build Docker Image (single source)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image for all image jobs
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      - name: Export image to cache (prevent prune)
        run: |
          echo "This step keeps the image alive across jobs."

  trivy-scan:
    name: 'Trivy - Vulnerability Scan (Dockerfile)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Run Trivy on Dockerfile'
        uses: aquasecurity/trivy-action@v0.19.0
        with:
          image-ref: 'Dockerfile'
          scan-type: 'config'
          format: 'table'
          exit-code: '1'

  dockle-scan:
    name: 'Dockle - Docker Image Linter'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Load Docker image from previous build'
        run: |
          echo "Image is available as ${{ env.IMAGE_NAME }}"
      - name: 'Run Dockle'
        uses: goodwithtech/dockle-action@main
        with:
          image: ${{ env.IMAGE_NAME }}
          exit-code: '1'

  grype-scan:
    name: 'Grype - Container Vulnerability Scan'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Scan docker image with Grype'
        uses: anchore/scan-action@v3
        with:
          image: ${{ env.IMAGE_NAME }}
          fail-build: true
          severity-cutoff: high

  syft-sbom:
    name: 'Syft - Generate SBOM'
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Generate SBOM (spdx-json)'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE_NAME }}
          format: spdx-json
          output-file: sbom.json
      - name: 'Upload SBOM as artifact'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: sbom.json

  polaris-score:
    name: 'Polaris - K8s Policy Enforcement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Install Polaris CLI'
        run: |
          curl -sSL https://github.com/FairwindsOps/polaris/releases/download/8.5.0/polaris_linux_amd64.tar.gz | tar xz
          sudo mv polaris /usr/local/bin/
      - name: 'Run Polaris Score on manifests'
        run: |
          if [ -d "manifests" ]; then
            polaris audit --audit-path manifests --set-exit-code-on-error true
          else
            echo 'No manifests/ directory found.'
          fi

  kubeconform-validate:
    name: 'kubeconform - YAML Schema Validation'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Install kubeconform'
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          chmod +x kubeconform
          sudo mv kubeconform /usr/local/bin/
      - name: 'Validate K8s manifests'
        run: |
          if [ -d "manifests" ]; then
            kubeconform -strict -summary manifests/*.yaml
          else
            echo 'No manifests/ directory found.'
          fi

  conftest-policy:
    name: 'Conftest - OPA Policy Check'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Install conftest'
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.0/conftest_0.49.0_Linux_x86_64.tar.gz
          tar -xzf conftest_0.49.0_Linux_x86_64.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
      - name: 'Run conftest on K8s manifests (if policies exist)'
        run: |
          if [ -d "policies" ] && [ -d "manifests" ]; then
            echo "✅ Found policies/ and manifests/ - running conftest"
            shopt -s nullglob
            for file in manifests/*.yaml; do
              echo "Testing $file..."
              conftest test "$file" --policy policies/ || exit 1
            done
          else
            echo "⚠️ No policies/ or manifests/ directory - skipping conftest"
          fi

  summary:
    name: 'Workflow Summary - Check All Results'
    needs: [trivy-scan, dockle-scan, grype-scan, syft-sbom, polaris-score, kubeconform-validate, conftest-policy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check overall status
        run: |
          echo 'Summary of all jobs:'
          code=0
          for job in "trivy-scan" "dockle-scan" "grype-scan" "syft-sbom" "polaris-score" "kubeconform-validate" "conftest-policy"; do
            status="${{ needs[job].result }}"
            echo "$job: $status"
            if [[ "$status" != "success" ]]; then
              code=1
            fi
          done
          if [[ $code -ne 0 ]]; then
            echo '❌ Workflow FAILED. Check the logs above.'
            exit 1
          else
            echo '✅ All security/K8s checks passed.'
          fi
