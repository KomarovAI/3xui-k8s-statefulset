name: Full Security & K8s Validation + Runtime Tests (Production-Ready)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: test-image:local
  TRIVY_VERSION: 0.50.2
  DOCKLE_VERSION: 0.4.15
  GRYPE_VERSION: 0.75.0
  SYFT_VERSION: 1.4.0
  POLARIS_VERSION: 8.5.0
  KUBECONFORM_VERSION: 0.6.4
  CONFTEST_VERSION: 0.49.0
  HADOLINT_VERSION: 2.12.0
  DIVE_VERSION: 0.12.0
  KUBESCORE_VERSION: 1.18.0

jobs:
  # ============================================
  # BUILD —Å DOCKER LAYER CACHING (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ #2)
  # ============================================
  build-image:
    name: 'Build Docker Image (with layer cache)'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–ª—è –∑–∞–ø–∏—Å–∏ –∫–µ—à–∞
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: ${{ env.IMAGE_NAME }}
          outputs: type=docker,dest=/tmp/image.tar
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
      
      - name: Rotate cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Compress image
        run: gzip -c /tmp/image.tar > image.tar.gz
      
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar.gz
          retention-days: 7

  # ============================================
  # SMOKE TESTS —Å FALLBACK (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ #3)
  # ============================================
  smoke-test:
    name: 'üî• Smoke Tests - Quick Validation'
    needs: build-image
    runs-on: self-hosted
    timeout-minutes: 5
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Create test volume
        run: docker volume create smoke-test-pvc-${{ github.run_id }}
      
      - name: Run smoke test container
        run: |
          docker run -d \
            --name smoke-test-${{ github.run_id }} \
            -p 12053:2053 \
            -p 12096:2096 \
            -v smoke-test-pvc-${{ github.run_id }}:/etc/x-ui:rw \
            --health-cmd='curl -sf http://localhost:2053/ -m 5 || exit 1' \
            --health-interval=5s \
            --health-timeout=3s \
            --health-retries=3 \
            ${{ env.IMAGE_NAME }}
          
          echo "‚è≥ Waiting for container health..."
          timeout 60 sh -c 'until docker inspect --format="{{.State.Health.Status}}" smoke-test-${{ github.run_id }} | grep -q healthy; do sleep 2; done' || true
          sleep 5
      
      - name: Run all smoke tests (combined with fallback)
        run: |
          EXIT_CODE=0
          
          # Test 1: Container running
          if docker ps | grep -q smoke-test-${{ github.run_id }}; then
            echo "‚úÖ [1/6] Container is running"
          else
            echo "‚ùå [1/6] Container failed to start"
            docker logs smoke-test-${{ github.run_id }}
            EXIT_CODE=1
          fi
          
          # Test 2: Process alive
          if docker exec smoke-test-${{ github.run_id }} pgrep -f x-ui > /dev/null 2>&1; then
            echo "‚úÖ [2/6] x-ui process is running"
          else
            echo "‚ùå [2/6] x-ui process not found"
            docker exec smoke-test-${{ github.run_id }} ps aux || true
            EXIT_CODE=1
          fi
          
          # Test 3: Ports listening (—Å fallback) ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
          PORT_COUNT=0
          if docker exec smoke-test-${{ github.run_id }} command -v netstat > /dev/null 2>&1; then
            echo "Using netstat for port check..."
            PORT_COUNT=$(docker exec smoke-test-${{ github.run_id }} netstat -tuln 2>/dev/null | grep -E ':2053|:2096' | wc -l)
          elif docker exec smoke-test-${{ github.run_id }} command -v ss > /dev/null 2>&1; then
            echo "Using ss for port check..."
            PORT_COUNT=$(docker exec smoke-test-${{ github.run_id }} ss -tuln 2>/dev/null | grep -E ':2053|:2096' | wc -l)
          else
            echo "Fallback: using curl for port check..."
            if curl -sf http://localhost:12053/ -m 2 > /dev/null 2>&1; then
              PORT_COUNT=$((PORT_COUNT + 1))
            fi
            if curl -sf http://localhost:12096/ -m 2 > /dev/null 2>&1; then
              PORT_COUNT=$((PORT_COUNT + 1))
            fi
          fi
          
          if [ "$PORT_COUNT" -eq 2 ]; then
            echo "‚úÖ [3/6] Both ports listening (2053, 2096)"
          else
            echo "‚ùå [3/6] Ports not listening (found: $PORT_COUNT/2)"
            EXIT_CODE=1
          fi
          
          # Test 4: HTTP healthcheck
          if curl -sf http://localhost:12053/ -m 5 > /dev/null 2>&1; then
            echo "‚úÖ [4/6] Healthcheck endpoint responsive"
          else
            echo "‚ùå [4/6] Healthcheck failed"
            docker logs smoke-test-${{ github.run_id }} --tail 50
            EXIT_CODE=1
          fi
          
          # Test 5: PVC writable
          TEST_DATA="smoke-$(date +%s)"
          if docker exec smoke-test-${{ github.run_id }} bash -c "echo '$TEST_DATA' > /etc/x-ui/test.txt && cat /etc/x-ui/test.txt" 2>/dev/null | grep -q "$TEST_DATA"; then
            echo "‚úÖ [5/6] PVC is writable and readable"
            docker exec smoke-test-${{ github.run_id }} rm /etc/x-ui/test.txt 2>/dev/null || true
          else
            echo "‚ùå [5/6] PVC write/read failed"
            EXIT_CODE=1
          fi
          
          # Test 6: Correct permissions
          OWNER=$(docker exec smoke-test-${{ github.run_id }} stat -c '%U:%G' /etc/x-ui 2>/dev/null || echo "unknown")
          if [ "$OWNER" = "x-ui:x-ui" ]; then
            echo "‚úÖ [6/6] Correct ownership: $OWNER"
          else
            echo "‚ùå [6/6] Incorrect ownership: $OWNER (expected x-ui:x-ui)"
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "üéâ All smoke tests passed!"
          fi
          
          exit $EXIT_CODE
      
      - name: Export smoke test logs
        if: always()
        run: |
          docker logs smoke-test-${{ github.run_id }} > smoke-test.log 2>&1 || true
      
      - name: Upload smoke test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: smoke-test.log
          retention-days: 7
      
      - name: Cleanup smoke test resources
        if: always()
        run: |
          docker stop smoke-test-${{ github.run_id }} || true
          docker rm smoke-test-${{ github.run_id }} || true
          docker volume rm smoke-test-pvc-${{ github.run_id }} || true

  # ============================================
  # HEALTH PROBES —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º URL (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ #1)
  # ============================================
  health-probes-test:
    name: 'ü©∫ Health Probes - K8s Readiness'
    needs: smoke-test
    runs-on: self-hosted
    timeout-minutes: 10
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache KIND binary
        uses: actions/cache@v4
        id: cache-kind
        with:
          path: /usr/local/bin/kind
          key: ${{ runner.os }}-kind-v0.20.0
      
      - name: Install KIND
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          echo "üì¶ Installing KIND..."
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
      
      - name: Verify KIND installation
        run: |
          echo "‚úÖ KIND version: $(kind version)"
      
      - name: Create ephemeral KIND cluster
        run: |
          CLUSTER_NAME="probe-${{ github.run_id }}"
          echo "Creating KIND cluster: $CLUSTER_NAME"
          kind create cluster --name $CLUSTER_NAME --wait 2m
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      
      - name: Load image into KIND
        run: |
          gunzip -c image.tar.gz | docker load
          kind load docker-image ${{ env.IMAGE_NAME }} --name probe-${{ github.run_id }}
          echo "‚úÖ Image loaded into KIND cluster"
      
      - name: Deploy pod with health probes
        run: |
          kubectl create namespace probe-test
          
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Pod
          metadata:
            name: xui-probe-test
            namespace: probe-test
            labels:
              app: xui
              test: health-probes
          spec:
            containers:
            - name: xui
              image: ${{ env.IMAGE_NAME }}
              imagePullPolicy: Never
              ports:
              - containerPort: 2053
                name: http
              - containerPort: 2096
                name: secondary
              
              startupProbe:
                httpGet:
                  path: /
                  port: 2053
                  scheme: HTTP
                initialDelaySeconds: 5
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 10
                successThreshold: 1
              
              livenessProbe:
                httpGet:
                  path: /
                  port: 2053
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
                successThreshold: 1
              
              readinessProbe:
                httpGet:
                  path: /
                  port: 2053
                initialDelaySeconds: 10
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 2
                successThreshold: 1
              
              volumeMounts:
              - name: data
                mountPath: /etc/x-ui
              
              securityContext:
                runAsUser: 2000
                runAsGroup: 2000
                allowPrivilegeEscalation: false
            
            volumes:
            - name: data
              emptyDir: {}
            
            securityContext:
              fsGroup: 2000
          EOF
          
          echo "‚úÖ Pod deployed with health probes"
      
      - name: ‚úì Test 1/4 - Startup probe succeeds
        run: |
          echo "‚è≥ Waiting for startup probe..."
          if kubectl wait --for=condition=Started pod/xui-probe-test -n probe-test --timeout=60s; then
            echo "‚úÖ Startup probe succeeded"
          else
            echo "‚ùå Startup probe failed"
            kubectl describe pod xui-probe-test -n probe-test
            kubectl logs xui-probe-test -n probe-test
            exit 1
          fi
      
      - name: ‚úì Test 2/4 - Readiness probe succeeds
        run: |
          echo "‚è≥ Waiting for readiness probe..."
          if kubectl wait --for=condition=Ready pod/xui-probe-test -n probe-test --timeout=60s; then
            echo "‚úÖ Readiness probe succeeded"
          else
            echo "‚ùå Readiness probe failed"
            kubectl describe pod xui-probe-test -n probe-test
            exit 1
          fi
      
      - name: ‚úì Test 3/4 - Liveness probe is functional
        run: |
          echo "Testing liveness probe endpoint..."
          if kubectl exec xui-probe-test -n probe-test -- curl -sf http://localhost:2053/ -m 5; then
            echo "‚úÖ Liveness probe endpoint responsive"
          else
            echo "‚ùå Liveness probe endpoint not responding"
            exit 1
          fi
          
          LIVENESS_STATUS=$(kubectl get pod xui-probe-test -n probe-test -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}')
          if [ "$LIVENESS_STATUS" = "True" ]; then
            echo "‚úÖ Pod reports healthy state"
          else
            echo "‚ùå Pod state unhealthy: $LIVENESS_STATUS"
            exit 1
          fi
      
      - name: ‚úì Test 4/4 - Graceful shutdown
        run: |
          echo "Testing graceful shutdown..."
          START_TIME=$(date +%s)
          kubectl delete pod xui-probe-test -n probe-test --grace-period=30 &
          DELETE_PID=$!
          
          if wait $DELETE_PID; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            if [ $DURATION -le 35 ]; then
              echo "‚úÖ Graceful shutdown: ${DURATION}s (within grace period)"
            else
              echo "‚ö†Ô∏è  Shutdown took ${DURATION}s (exceeded 30s grace period)"
            fi
          else
            echo "‚ùå Graceful shutdown failed"
            exit 1
          fi
      
      - name: Export health probe logs
        if: always()
        run: |
          kubectl logs xui-probe-test -n probe-test --previous > health-probe-previous.log 2>&1 || true
          kubectl logs xui-probe-test -n probe-test > health-probe-current.log 2>&1 || true
          kubectl describe pod xui-probe-test -n probe-test > health-probe-describe.log 2>&1 || true
          kubectl get events -n probe-test --sort-by='.lastTimestamp' > health-probe-events.log 2>&1 || true
      
      - name: Upload health probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-probe-logs
          path: health-probe-*.log
          retention-days: 7
      
      - name: Cleanup KIND cluster
        if: always()
        run: |
          kind delete cluster --name probe-${{ github.run_id }} || true

  # ============================================
  # NON-BLOCKING STATIC ANALYSIS (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ #2)
  # ============================================
  hadolint-lint:
    name: 'Hadolint - Dockerfile Optimization'
    needs: build-image
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Hadolint
        uses: actions/cache@v4
        id: cache-hadolint
        with:
          path: /usr/local/bin/hadolint
          key: hadolint-${{ env.HADOLINT_VERSION }}
      
      - name: Install Hadolint
        if: steps.cache-hadolint.outputs.cache-hit != 'true'
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v${{ env.HADOLINT_VERSION }}/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      
      - name: Run Hadolint
        run: |
          hadolint Dockerfile > hadolint.log || echo "‚ö†Ô∏è  Hadolint found issues (non-blocking)"
      
      - name: Upload Hadolint RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-hadolint
          path: hadolint.log
          retention-days: 7

  dive-analysis:
    name: 'Dive - Image Efficiency'
    needs: build-image
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Cache Dive
        uses: actions/cache@v4
        id: cache-dive
        with:
          path: /usr/local/bin/dive
          key: dive-${{ env.DIVE_VERSION }}
      
      - name: Install Dive
        if: steps.cache-dive.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/wagoodman/dive/releases/download/v${{ env.DIVE_VERSION }}/dive_${{ env.DIVE_VERSION }}_linux_amd64.tar.gz
          tar -xzf dive_${{ env.DIVE_VERSION }}_linux_amd64.tar.gz
          sudo mv dive /usr/local/bin/
      
      - name: Run Dive
        run: |
          CI=true dive ${{ env.IMAGE_NAME }} --ci > dive.log || echo "‚ö†Ô∏è  Dive found issues (non-blocking)"
      
      - name: Upload Dive RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-dive
          path: dive.log
          retention-days: 7

  kube-score:
    name: 'Kube-Score - K8s Best Practices'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache kube-score
        uses: actions/cache@v4
        id: cache-kubescore
        with:
          path: /usr/local/bin/kube-score
          key: kubescore-${{ env.KUBESCORE_VERSION }}
      
      - name: Install kube-score
        if: steps.cache-kubescore.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v${{ env.KUBESCORE_VERSION }}/kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          tar -xzf kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/
      
      - name: Run kube-score
        run: |
          if [ -d "manifests" ]; then
            kube-score score manifests/*.yaml --output-format ci > kube-score.log || echo "‚ö†Ô∏è  Kube-score found issues (non-blocking)"
          else
            echo 'No manifests/ for analysis' > kube-score.log
          fi
      
      - name: Upload Kube-Score RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-kubescore
          path: kube-score.log
          retention-days: 7

  trivy-scan:
    name: 'Trivy - CVE Scan'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Trivy
        uses: actions/cache@v4
        id: cache-trivy
        with:
          path: /usr/local/bin/trivy
          key: trivy-${{ env.TRIVY_VERSION }}
      
      - name: Install Trivy
        if: steps.cache-trivy.outputs.cache-hit != 'true'
        run: |
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${{ env.TRIVY_VERSION }}/trivy_${{ env.TRIVY_VERSION }}_Linux-64bit.tar.gz | tar xz
          sudo mv trivy /usr/local/bin/
      
      - name: Run Trivy
        run: |
          trivy config Dockerfile > trivy.log || echo "‚ö†Ô∏è  Trivy found issues (non-blocking)"
      
      - name: Upload Trivy RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-trivy
          path: trivy.log
          retention-days: 7

  dockle-scan:
    name: 'Dockle - Docker Hardening'
    needs: build-image
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Dockle
        uses: actions/cache@v4
        id: cache-dockle
        with:
          path: /usr/local/bin/dockle
          key: dockle-${{ env.DOCKLE_VERSION }}
      
      - name: Install Dockle
        if: steps.cache-dockle.outputs.cache-hit != 'true'
        run: |
          wget -O - https://github.com/goodwithtech/dockle/releases/download/v${{ env.DOCKLE_VERSION }}/dockle_${{ env.DOCKLE_VERSION }}_Linux-64bit.tar.gz | tar xz
          sudo mv dockle /usr/local/bin/
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Run Dockle
        run: |
          dockle ${{ env.IMAGE_NAME }} > dockle.log || echo "‚ö†Ô∏è  Dockle found issues (non-blocking)"
      
      - name: Upload Dockle RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-dockle
          path: dockle.log
          retention-days: 7

  grype-scan:
    name: 'Grype - Vulnerability Scan'
    needs: build-image
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Grype
        uses: actions/cache@v4
        id: cache-grype
        with:
          path: /usr/local/bin/grype
          key: grype-${{ env.GRYPE_VERSION }}
      
      - name: Install Grype
        if: steps.cache-grype.outputs.cache-hit != 'true'
        run: |
          wget -O- https://github.com/anchore/grype/releases/download/v${{ env.GRYPE_VERSION }}/grype_${{ env.GRYPE_VERSION }}_linux_amd64.tar.gz | tar xz
          sudo mv grype /usr/local/bin/
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Run Grype
        run: |
          grype ${{ env.IMAGE_NAME }} > grype.log || echo "‚ö†Ô∏è  Grype found issues (non-blocking)"
      
      - name: Upload Grype RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-grype
          path: grype.log
          retention-days: 7

  syft-sbom:
    name: 'Syft - SBOM Generation'
    needs: build-image
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Syft
        uses: actions/cache@v4
        id: cache-syft
        with:
          path: /usr/local/bin/syft
          key: syft-${{ env.SYFT_VERSION }}
      
      - name: Install Syft
        if: steps.cache-syft.outputs.cache-hit != 'true'
        run: |
          wget -O- https://github.com/anchore/syft/releases/download/v${{ env.SYFT_VERSION }}/syft_${{ env.SYFT_VERSION }}_linux_amd64.tar.gz | tar xz
          sudo mv syft /usr/local/bin/
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: built-image
      
      - name: Load Docker image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Generate SBOM
        run: |
          syft ${{ env.IMAGE_NAME }} -o spdx-json > syft.log || echo "‚ö†Ô∏è  Syft generation issues (non-blocking)"
      
      - name: Upload Syft RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-syft
          path: syft.log
          retention-days: 7

  polaris-score:
    name: 'Polaris - Policy Enforcement'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Polaris
        uses: actions/cache@v4
        id: cache-polaris
        with:
          path: /usr/local/bin/polaris
          key: polaris-${{ env.POLARIS_VERSION }}
      
      - name: Install Polaris
        if: steps.cache-polaris.outputs.cache-hit != 'true'
        run: |
          wget -O- https://github.com/FairwindsOps/polaris/releases/download/${{ env.POLARIS_VERSION }}/polaris_linux_amd64.tar.gz | tar xz
          sudo mv polaris /usr/local/bin/
      
      - name: Run Polaris
        run: |
          if [ -d "manifests" ]; then
            polaris audit --audit-path manifests > polaris.log || echo "‚ö†Ô∏è  Polaris found issues (non-blocking)"
          else
            echo 'No manifests/ for analysis' > polaris.log
          fi
      
      - name: Upload Polaris RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-polaris
          path: polaris.log
          retention-days: 7

  kubeconform-validate:
    name: 'Kubeconform - YAML Validation'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Kubeconform
        uses: actions/cache@v4
        id: cache-kubeconform
        with:
          path: /usr/local/bin/kubeconform
          key: kubeconform-${{ env.KUBECONFORM_VERSION }}
      
      - name: Install Kubeconform
        if: steps.cache-kubeconform.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v${{ env.KUBECONFORM_VERSION }}/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          chmod +x kubeconform
          sudo mv kubeconform /usr/local/bin/
      
      - name: Validate manifests
        run: |
          if [ -d "manifests" ]; then
            kubeconform -strict -summary manifests/*.yaml > kubeconform.log || echo "‚ö†Ô∏è  Kubeconform found issues (non-blocking)"
          else
            echo 'No manifests/ for analysis' > kubeconform.log
          fi
      
      - name: Upload Kubeconform RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-kubeconform
          path: kubeconform.log
          retention-days: 7

  conftest-policy:
    name: 'Conftest - OPA Policy'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Conftest
        uses: actions/cache@v4
        id: cache-conftest
        with:
          path: /usr/local/bin/conftest
          key: conftest-${{ env.CONFTEST_VERSION }}
      
      - name: Install Conftest
        if: steps.cache-conftest.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          tar -xzf conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
      
      - name: Run Conftest
        run: |
          if [ -d "policies" ] && [ -d "manifests" ]; then
            conftest test manifests/*.yaml > conftest.log || echo "‚ö†Ô∏è  Conftest found issues (non-blocking)"
          else
            echo 'No policies/ or manifests/ for analysis' > conftest.log
          fi
      
      - name: Upload Conftest RAW
        uses: actions/upload-artifact@v4
        with:
          name: raw-conftest
          path: conftest.log
          retention-days: 7

  # ============================================
  # –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–í–û–î–ö–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ #4, #5)
  # ============================================
  summary:
    name: 'Workflow Final Status'
    needs: [
      hadolint-lint, 
      dive-analysis, 
      kube-score, 
      trivy-scan, 
      dockle-scan, 
      grype-scan, 
      syft-sbom, 
      polaris-score, 
      kubeconform-validate, 
      conftest-policy,
      smoke-test,
      health-probes-test
    ]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      actions: write  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Aggregate all logs with structure
        run: |
          echo "=======================" > security-full-raw.txt
          echo "WORKFLOW SECURITY REPORT" >> security-full-raw.txt
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-full-raw.txt
          echo "=======================" >> security-full-raw.txt
          echo "" >> security-full-raw.txt
          
          # Static analysis logs
          echo "### STATIC ANALYSIS ###" >> security-full-raw.txt
          echo "" >> security-full-raw.txt
          for dir in raw-*; do
            if [ -d "$dir" ]; then
              echo "--- $(echo $dir | sed 's/raw-//') ---" >> security-full-raw.txt
              if ls "$dir"/* > /dev/null 2>&1; then
                cat "$dir"/* >> security-full-raw.txt 2>/dev/null
              else
                echo "No logs found" >> security-full-raw.txt
              fi
              echo "" >> security-full-raw.txt
            fi
          done
          
          # Smoke test logs
          if [ -f "smoke-test-logs/smoke-test.log" ]; then
            echo "### SMOKE TESTS ###" >> security-full-raw.txt
            cat smoke-test-logs/smoke-test.log >> security-full-raw.txt
            echo "" >> security-full-raw.txt
          fi
          
          # Health probe logs
          if [ -d "health-probe-logs" ]; then
            echo "### HEALTH PROBES ###" >> security-full-raw.txt
            for log in health-probe-logs/*.log; do
              if [ -f "$log" ]; then
                echo "--- $(basename $log) ---" >> security-full-raw.txt
                cat "$log" >> security-full-raw.txt
                echo "" >> security-full-raw.txt
              fi
            done
          fi
          
          echo "=======================" >> security-full-raw.txt
          echo "Report size: $(wc -c < security-full-raw.txt) bytes" >> security-full-raw.txt
      
      - name: Upload unified report
        uses: actions/upload-artifact@v4
        with:
          name: security-full-raw
          path: security-full-raw.txt
          retention-days: 30
      
      - name: Show overall status with timing
        run: |
          echo "# üîç –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Timing info
          echo "‚è±Ô∏è  **Workflow Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **Started**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üöÄ Runtime Tests (–ë–õ–û–ö–ò–†–£–Æ–©–ò–ï)" >> $GITHUB_STEP_SUMMARY
          
          blocking_failed=0
          
          # Smoke test status
          smoke_status="${{ needs.smoke-test.result }}"
          if [[ "$smoke_status" == "success" ]]; then
            echo "‚úÖ üî• **Smoke Tests**: PASSED (~30-60s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå üî• **Smoke Tests**: FAILED ‚Äî **–î–ï–ü–õ–û–ô –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù**" >> $GITHUB_STEP_SUMMARY
            blocking_failed=1
          fi
          
          # Health probes status
          health_status="${{ needs.health-probes-test.result }}"
          if [[ "$health_status" == "success" ]]; then
            echo "‚úÖ ü©∫ **Health Probes**: PASSED (~2-3 min)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå ü©∫ **Health Probes**: FAILED ‚Äî **–î–ï–ü–õ–û–ô –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù**" >> $GITHUB_STEP_SUMMARY
            blocking_failed=1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üõ°Ô∏è Security & Static Analysis (NON-BLOCKING)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          warnings=0
          successes=0
          skipped=0
          
          declare -A job_results
          job_results["hadolint-lint"]="${{ needs.hadolint-lint.result }}"
          job_results["dive-analysis"]="${{ needs.dive-analysis.result }}"
          job_results["kube-score"]="${{ needs.kube-score.result }}"
          job_results["trivy-scan"]="${{ needs.trivy-scan.result }}"
          job_results["dockle-scan"]="${{ needs.dockle-scan.result }}"
          job_results["grype-scan"]="${{ needs.grype-scan.result }}"
          job_results["syft-sbom"]="${{ needs.syft-sbom.result }}"
          job_results["polaris-score"]="${{ needs.polaris-score.result }}"
          job_results["kubeconform-validate"]="${{ needs.kubeconform-validate.result }}"
          job_results["conftest-policy"]="${{ needs.conftest-policy.result }}"
          
          for job in "${!job_results[@]}"; do
            status="${job_results[$job]}"
            if [[ "$status" == "success" ]]; then
              echo "‚úÖ **$job**: passed" >> $GITHUB_STEP_SUMMARY
              successes=$((successes + 1))
            elif [[ "$status" == "failure" ]]; then
              echo "‚ö†Ô∏è  **$job**: issues found (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–ø–ª–æ–π)" >> $GITHUB_STEP_SUMMARY
              warnings=$((warnings + 1))
            else
              echo "‚è≠Ô∏è  **$job**: skipped" >> $GITHUB_STEP_SUMMARY
              skipped=$((skipped + 1))
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Final verdict
          if [[ $blocking_failed -eq 0 ]]; then
            if [[ $warnings -eq 0 ]]; then
              echo "## ‚úÖ **–í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üéâ –û–±—Ä–∞–∑ –≥–æ—Ç–æ–≤ –∫ production deployment!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: $successes —É—Å–ø–µ—à–Ω–æ, $warnings –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π, $skipped –ø—Ä–æ–ø—É—â–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ‚ö†Ô∏è  **–ö–†–ò–¢–ò–ß–ù–´–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ **$warnings –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π** –≤ static analysis." >> $GITHUB_STEP_SUMMARY
              echo "–û–±—Ä–∞–∑ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: $successes —É—Å–ø–µ—à–Ω–æ, $warnings –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π, $skipped –ø—Ä–æ–ø—É—â–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üíæ **Unified Report**: –î–æ—Å—Ç—É–ø–µ–Ω –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö (security-full-raw)" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "## ‚ùå **–ö–†–ò–¢–ò–ß–ù–´–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ï–ù–´**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üö´ **–î–ï–ü–õ–û–ô –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ smoke-test –∏/–∏–ª–∏ health-probes-test –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: $successes —É—Å–ø–µ—à–Ω–æ, $warnings –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π, $skipped –ø—Ä–æ–ø—É—â–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
