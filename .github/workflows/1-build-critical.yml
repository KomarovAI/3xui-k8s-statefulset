name: "âš¡ Critical Path: Build & Runtime Tests"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel redundant runs
concurrency:
  group: critical-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  IMAGE_NAME: test-image:local

jobs:
  build-image:
    name: 'Build Docker Image'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: Build Docker image
        id: build
        timeout-minutes: 15
        uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75 # v6.9.0
        with:
          context: .
          tags: ${{ env.IMAGE_NAME }}
          outputs: type=docker,dest=/tmp/image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Compress & validate image
        run: |
          gzip -c /tmp/image.tar > image.tar.gz
          SIZE=$(stat -c%s image.tar.gz 2>/dev/null || stat -f%z image.tar.gz)
          echo "ðŸ“¦ Image size: $SIZE bytes"
          [ "$SIZE" -lt 1000000 ] && echo "âŒ Image too small" && exit 1
          gzip -t image.tar.gz || { echo "âŒ Corrupted archive"; exit 1; }
          echo "âœ… Image validation passed"

      - name: Upload image artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: docker-image-${{ github.sha }}
          path: image.tar.gz
          retention-days: 7
          compression-level: 0

  smoke-test:
    name: 'ðŸ”¥ Smoke Tests'
    needs: build-image
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'self-hosted' }}
    timeout-minutes: 7
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Docker image
        timeout-minutes: 3
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: docker-image-${{ github.sha }}

      - name: Load & run container with dynamic ports
        run: |
          gunzip -c image.tar.gz | docker load
          docker volume create smoke-test-pvc-${{ github.run_id }}
          docker run -d \
            --name smoke-test-${{ github.run_id }} \
            -p 0:2053 \
            -p 0:2096 \
            -v smoke-test-pvc-${{ github.run_id }}:/etc/x-ui:rw \
            --health-cmd='curl -sf http://localhost:2053/ -m 5 || exit 1' \
            --health-interval=5s \
            --health-timeout=3s \
            --health-retries=3 \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=100m \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --cap-add=NET_BIND_SERVICE \
            ${{ env.IMAGE_NAME }}
          timeout 60 sh -c 'until docker inspect --format="{{.State.Health.Status}}" smoke-test-${{ github.run_id }} | grep -q healthy; do sleep 2; done'
          sleep 5
          PRIMARY_PORT=$(docker port smoke-test-${{ github.run_id }} 2053 | cut -d: -f2)
          SECONDARY_PORT=$(docker port smoke-test-${{ github.run_id }} 2096 | cut -d: -f2)
          echo "PRIMARY_PORT=${PRIMARY_PORT}" >> $GITHUB_ENV
          echo "SECONDARY_PORT=${SECONDARY_PORT}" >> $GITHUB_ENV
          echo "ðŸ”Œ Ports: $PRIMARY_PORT, $SECONDARY_PORT"

      - name: Run smoke tests
        timeout-minutes: 3
        run: |
          EXIT_CODE=0
          # Test 1: Container running
          docker ps | grep -q smoke-test-${{ github.run_id }} || { echo "âŒ Container not running"; docker ps -a | grep smoke-test || true; EXIT_CODE=1; }
          # Test 2: Process running
          docker exec smoke-test-${{ github.run_id }} pgrep -f x-ui >/dev/null 2>&1 || { echo "âŒ x-ui process not found"; docker exec smoke-test-${{ github.run_id }} ps aux || true; EXIT_CODE=1; }
          # Test 3: Ports listening
          PORT_COUNT=0
          curl -sf http://localhost:${PRIMARY_PORT}/ -m 2 >/dev/null && PORT_COUNT=$((PORT_COUNT + 1))
          curl -sf http://localhost:${SECONDARY_PORT}/ -m 2 >/dev/null && PORT_COUNT=$((PORT_COUNT + 1))
          [ "$PORT_COUNT" -eq 2 ] || { echo "âŒ Ports not listening (found: $PORT_COUNT/2)"; EXIT_CODE=1; }
          # Test 4: Healthcheck
          curl -sf http://localhost:${PRIMARY_PORT}/ -m 5 >/dev/null || { echo "âŒ Healthcheck failed"; docker logs smoke-test-${{ github.run_id }} | tail -n 50; EXIT_CODE=1; }
          # Test 5: PVC writable
          TEST_DATA="smoke-$(date +%s)"
          docker exec smoke-test-${{ github.run_id }} bash -c "echo '$TEST_DATA' > /etc/x-ui/test.txt && cat /etc/x-ui/test.txt" | grep -q "$TEST_DATA" || { echo "âŒ PVC not writable"; EXIT_CODE=1; }
          # Test 6: Ownership
          OWNER=$(docker exec smoke-test-${{ github.run_id }} stat -c '%U:%G' /etc/x-ui 2>/dev/null)
          [ "$OWNER" = "x-ui:x-ui" ] || { echo "âŒ Wrong ownership: $OWNER"; EXIT_CODE=1; }
          # Test 7: Security - Read-only rootfs
          docker inspect smoke-test-${{ github.run_id }} --format='{{.HostConfig.ReadonlyRootfs}}' | grep -q true || { echo "âŒ Root filesystem not read-only"; EXIT_CODE=1; }
          [ $EXIT_CODE -eq 0 ] && echo "ðŸŽ‰ All smoke tests passed!"
          exit $EXIT_CODE

      - name: Export logs
        if: always()
        run: docker logs smoke-test-${{ github.run_id }} > smoke-test.log 2>&1 || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: smoke-test-logs-${{ github.sha }}
          path: smoke-test.log
          retention-days: 14

      - name: Cleanup
        if: always()
        run: |
          docker stop smoke-test-${{ github.run_id }} || true
          docker rm smoke-test-${{ github.run_id }} || true
          docker volume rm smoke-test-pvc-${{ github.run_id }} || true

  health-probes-test:
    name: 'ðŸ©º Health Probes - K8s Readiness'
    needs: build-image
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'self-hosted' }}
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cache KIND binary
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        id: cache-kind
        with:
          path: /usr/local/bin/kind
          key: ${{ runner.os }}-kind-v0.20.0-sha256

      - name: Install KIND with checksum validation
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          KIND_VERSION="0.20.0"
          KIND_CHECKSUM="513a7213d6c040e2f091def3558a5bf65481a8dfd8e01b8a4f4d5ba6752f0047"
          
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v${KIND_VERSION}/kind-linux-amd64"
          echo "${KIND_CHECKSUM}  kind" | sha256sum --check --strict || exit 1
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          echo "âœ… KIND installed and validated"

      - name: Create KIND cluster with PodSecurity
        timeout-minutes: 3
        run: |
          CLUSTER_NAME="probe-${{ github.run_id }}"
          kind create cluster --name $CLUSTER_NAME --wait 2m \
            --config - <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: ClusterConfiguration
              apiServer:
                extraArgs:
                  "enable-admission-plugins": "NodeRestriction,PodSecurity"
          EOF

      - name: Download & load image
        timeout-minutes: 3
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: docker-image-${{ github.sha }}

      - name: Load image into KIND
        run: |
          gunzip -c image.tar.gz | docker load
          kind load docker-image ${{ env.IMAGE_NAME }} --name probe-${{ github.run_id }}

      - name: Deploy pod with health probes and security context
        run: |
          kubectl create namespace probe-test
          kubectl label namespace probe-test pod-security.kubernetes.io/enforce=restricted
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Pod
          metadata:
            name: xui-probe-test
            namespace: probe-test
            labels:
              app: xui
          spec:
            securityContext:
              runAsNonRoot: true
              runAsUser: 2000
              runAsGroup: 2000
              fsGroup: 2000
              seccompProfile:
                type: RuntimeDefault
            containers:
            - name: xui
              image: ${{ env.IMAGE_NAME }}
              imagePullPolicy: Never
              ports:
              - containerPort: 2053
                name: http
              - containerPort: 2096
                name: secondary
              livenessProbe:
                httpGet:
                  path: /
                  port: 2053
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
              readinessProbe:
                httpGet:
                  path: /
                  port: 2053
                initialDelaySeconds: 10
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 3
              volumeMounts:
              - name: data
                mountPath: /etc/x-ui
              - name: tmp
                mountPath: /tmp
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                capabilities:
                  drop:
                  - ALL
                  add:
                  - NET_BIND_SERVICE
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
            volumes:
            - name: data
              emptyDir: {}
            - name: tmp
              emptyDir: {}
          EOF
          
          kubectl wait --for=condition=Ready pod/xui-probe-test -n probe-test --timeout=120s
          echo "âœ… Pod is ready with all probes passing!"

      - name: Verify probes and security
        run: |
          echo "=== Pod Description ==="
          kubectl describe pod xui-probe-test -n probe-test
          
          echo "
=== Security Context Validation ==="
          kubectl get pod xui-probe-test -n probe-test -o jsonpath='{.spec.securityContext}' | jq .
          kubectl get pod xui-probe-test -n probe-test -o jsonpath='{.spec.containers[0].securityContext}' | jq .
          
          echo "
=== Container Logs ==="
          kubectl logs xui-probe-test -n probe-test --tail=50

      - name: Cleanup
        if: always()
        run: kind delete cluster --name probe-${{ github.run_id }}

  critical-summary:
    name: 'âœ… Critical Path Status'
    needs: [smoke-test, health-probes-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Check critical failures
        run: |
          SMOKE="${{ needs.smoke-test.result }}"
          HEALTH="${{ needs.health-probes-test.result }}"
          echo "# ðŸš¨ Critical Path Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "$SMOKE" = "success" ]; then
            echo "| ðŸ”¥ Smoke Tests | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”¥ Smoke Tests | âŒ FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$HEALTH" = "success" ]; then
            echo "| ðŸ©º Health Probes | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ©º Health Probes | âŒ FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$SMOKE" != "success" ] || [ "$HEALTH" != "success" ]; then
            echo "## ðŸš« DEPLOYMENT BLOCKED" >> $GITHUB_STEP_SUMMARY
            echo "Critical tests failed. Review logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… READY FOR DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
          echo "All critical tests passed! ðŸš€" >> $GITHUB_STEP_SUMMARY
