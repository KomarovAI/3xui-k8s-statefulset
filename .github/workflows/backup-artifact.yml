name: Загрузка бэкапа 3X-UI в GitHub Artifacts

on:
  workflow_dispatch:

jobs:
  backup-artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v4

      - name: Установка kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Скачиваем последний бэкап из xui-panel pod
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          POD=$(kubectl get pod -n xui-vpn -l app=xui-panel -o jsonpath='{.items[0].metadata.name}')
          kubectl cp xui-vpn/$POD:/etc/x-ui/x-ui.db ./x-ui.db || true
          kubectl cp xui-vpn/$POD:/etc/x-ui/config.json ./config.json || true
          kubectl cp xui-vpn/$POD:/etc/x-ui/cert ./cert || true
          tar -czf xui-essential-backup-$(date +%Y%m%d-%H%M%S).tar.gz x-ui.db config.json cert

      - name: Загрузка в GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xui-essential-backup
          path: xui-essential-backup-*.tar.gz
