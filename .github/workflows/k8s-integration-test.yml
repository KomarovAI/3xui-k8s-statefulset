name: ğŸ¯ Kubernetes Integration Test

on:
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile*'
      - 'scripts/**'
      - '.github/workflows/k8s-integration-test.yml'
  push:
    branches: [main]
    paths:
      - 'Dockerfile*'
      - 'scripts/**'
  workflow_dispatch:

env:
  IMAGE_NAME: test-3xui:local

jobs:
  kind-test:
    name: ğŸ¯ Test in KIND (K3s-compatible)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build test image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Create KIND cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: v0.20.0
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
              extraMounts:
              - hostPath: /tmp/k8s-test-pv
                containerPath: /tmp/hostpath-provisioner
            - role: worker

      - name: ğŸ“¦ Load image to KIND
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster

      - name: ğŸš€ Deploy StatefulSet with PVC
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Namespace
          metadata:
            name: test-vpn
          ---
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: test-pv-0
          spec:
            capacity:
              storage: 1Gi
            accessModes:
              - ReadWriteOnce
            hostPath:
              path: /tmp/hostpath-provisioner/pv-0
              type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            clusterIP: None
            selector:
              app: xui
            ports:
            - name: web
              port: 2053
            - name: panel
              port: 2096
          ---
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            serviceName: xui
            replicas: 1
            selector:
              matchLabels:
                app: xui
            template:
              metadata:
                labels:
                  app: xui
              spec:
                containers:
                - name: xui
                  image: ${{ env.IMAGE_NAME }}
                  imagePullPolicy: Never
                  ports:
                  - name: web
                    containerPort: 2053
                  - name: panel
                    containerPort: 2096
                  env:
                  - name: XUI_ENABLE_FAIL2BAN
                    value: "false"
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 2053
                    initialDelaySeconds: 30
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 2053
                    initialDelaySeconds: 10
                    periodSeconds: 5
                    timeoutSeconds: 3
                    failureThreshold: 3
                  volumeMounts:
                  - name: data
                    mountPath: /etc/x-ui
                  securityContext:
                    runAsUser: 2000
                    runAsGroup: 2000
                    allowPrivilegeEscalation: false
                    readOnlyRootFilesystem: false
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
            volumeClaimTemplates:
            - metadata:
                name: data
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 1Gi
          EOF

      - name: â³ Wait for pod ready
        run: |
          echo "ğŸ” Waiting for pod to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=xui \
            -n test-vpn \
            --timeout=180s
          
          echo "âœ… Pod is ready!"

      - name: ğŸ§ª Test liveness probe endpoint
        run: |
          POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ¯ Testing liveness probe on $POD..."
          
          kubectl exec -n test-vpn $POD -- curl -f http://localhost:2053/ -m 5
          echo "âœ… Liveness probe works!"

      - name: ğŸ’¾ Test PVC mount and permissions
        run: |
          POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ’¾ Testing PVC mount on $POD..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
          kubectl exec -n test-vpn $POD -- ls -la /etc/x-ui
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ
          kubectl exec -n test-vpn $POD -- touch /etc/x-ui/test-write.txt
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ owner
          OWNER=$(kubectl exec -n test-vpn $POD -- stat -c '%U:%G' /etc/x-ui)
          if [ "$OWNER" != "x-ui:x-ui" ]; then
            echo "âŒ PVC owner incorrect: $OWNER"
            exit 1
          fi
          
          echo "âœ… PVC mount and permissions OK!"

      - name: ğŸ”„ Test PVC persistence across pod restart
        run: |
          POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ’¾ Writing test file to PVC..."
          
          # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ñ‚Ğ°Ğ¹Ğ¼ÑÑ‚Ğ°Ğ¼Ğ¿Ğ¾Ğ¼
          TIMESTAMP=$(date +%s)
          kubectl exec -n test-vpn $POD -- sh -c "echo $TIMESTAMP > /etc/x-ui/persistence-test.txt"
          
          echo "ğŸ—‘ï¸ Deleting pod to test persistence..."
          kubectl delete pod -n test-vpn $POD --wait=true
          
          echo "â³ Waiting for new pod..."
          kubectl wait --for=condition=ready pod \
            -l app=xui \
            -n test-vpn \
            --timeout=180s
          
          NEW_POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ” Checking file in new pod $NEW_POD..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ¾ÑÑ‚Ğ°Ğ»ÑÑ
          STORED_TIMESTAMP=$(kubectl exec -n test-vpn $NEW_POD -- cat /etc/x-ui/persistence-test.txt)
          
          if [ "$STORED_TIMESTAMP" != "$TIMESTAMP" ]; then
            echo "âŒ PVC persistence failed! Expected $TIMESTAMP, got $STORED_TIMESTAMP"
            exit 1
          fi
          
          echo "âœ… PVC persistence verified!"

      - name: ğŸ”’ Test SecurityContext (non-root)
        run: |
          POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ”’ Checking user/group..."
          
          UID=$(kubectl exec -n test-vpn $POD -- id -u)
          GID=$(kubectl exec -n test-vpn $POD -- id -g)
          
          if [ "$UID" != "2000" ] || [ "$GID" != "2000" ]; then
            echo "âŒ Wrong UID/GID: $UID:$GID (expected 2000:2000)"
            exit 1
          fi
          
          echo "âœ… SecurityContext OK (running as UID:GID 2000:2000)!"

      - name: ğŸŒ Test service connectivity
        run: |
          echo "ğŸŒ Testing service DNS resolution..."
          
          kubectl run -n test-vpn test-client --image=busybox:1.36 --rm -it --restart=Never \
            -- wget -O- http://xui.test-vpn.svc.cluster.local:2053/ --timeout=5
          
          echo "âœ… Service connectivity OK!"

      - name: ğŸ“Š Show pod status
        if: always()
        run: |
          echo "## ğŸ“Š Pod Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n test-vpn -o wide >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ’¾ PVC Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pvc -n test-vpn >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“œ Show pod logs
        if: always()
        run: |
          echo "## ğŸ“œ Pod Logs (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          kubectl logs -n test-vpn -l app=xui --tail=50 >> $GITHUB_STEP_SUMMARY || echo "No logs" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Describe pod
        if: always()
        run: |
          kubectl describe pod -n test-vpn -l app=xui
