name: ğŸ¯ Kubernetes Integration Test (Optimized)

on:
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile*'
      - 'scripts/**'
      - '.github/workflows/k8s-integration-test.yml'
  push:
    branches: [main]
    paths:
      - 'Dockerfile*'
      - 'scripts/**'
  workflow_dispatch:

env:
  IMAGE_NAME: test-3xui:local

jobs:
  # ========================================
  # STAGE 1: BUILD & DEPLOY TO KIND
  # ========================================
  
  setup-and-deploy:
    name: ğŸ¯ Setup KIND & Deploy
    runs-on: ubuntu-latest
    outputs:
      cluster-ready: ${{ steps.check.outputs.ready }}
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build test image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Create KIND cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: v0.20.0
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
              extraMounts:
              - hostPath: /tmp/k8s-test-pv
                containerPath: /tmp/hostpath-provisioner
            - role: worker

      - name: ğŸ“¦ Load image to KIND
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster

      - name: ğŸš€ Deploy StatefulSet with PVC
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Namespace
          metadata:
            name: test-vpn
          ---
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: test-pv-0
          spec:
            capacity:
              storage: 1Gi
            accessModes:
              - ReadWriteOnce
            hostPath:
              path: /tmp/hostpath-provisioner/pv-0
              type: DirectoryOrCreate
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            clusterIP: None
            selector:
              app: xui
            ports:
            - name: web
              port: 2053
            - name: panel
              port: 2096
          ---
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            serviceName: xui
            replicas: 1
            selector:
              matchLabels:
                app: xui
            template:
              metadata:
                labels:
                  app: xui
              spec:
                containers:
                - name: xui
                  image: ${{ env.IMAGE_NAME }}
                  imagePullPolicy: Never
                  ports:
                  - name: web
                    containerPort: 2053
                  - name: panel
                    containerPort: 2096
                  env:
                  - name: XUI_ENABLE_FAIL2BAN
                    value: "false"
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 2053
                    initialDelaySeconds: 30
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 2053
                    initialDelaySeconds: 10
                    periodSeconds: 5
                    timeoutSeconds: 3
                    failureThreshold: 3
                  volumeMounts:
                  - name: data
                    mountPath: /etc/x-ui
                  securityContext:
                    runAsUser: 2000
                    runAsGroup: 2000
                    allowPrivilegeEscalation: false
                    readOnlyRootFilesystem: false
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
            volumeClaimTemplates:
            - metadata:
                name: data
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 1Gi
          EOF

      - name: â³ Wait for pod ready
        run: |
          echo "ğŸ” Waiting for pod to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=xui \
            -n test-vpn \
            --timeout=180s
          
          echo "âœ… Pod is ready!"

      - name: ğŸ“Š Export cluster state
        id: check
        run: |
          echo "ready=true" >> $GITHUB_OUTPUT
          kubectl get pods -n test-vpn -o wide

  # ========================================
  # STAGE 2: PARALLEL TESTING (6 RUNNERS)
  # ========================================
  
  test-liveness-probe:
    name: ğŸ’š Liveness Probe Test
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build image
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Setup KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster-liveness
          version: v0.20.0

      - name: ğŸš€ Quick deploy
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster-liveness
          kubectl create namespace test-vpn
          kubectl run xui-test -n test-vpn --image=${{ env.IMAGE_NAME }} \
            --image-pull-policy=Never \
            --env="XUI_ENABLE_FAIL2BAN=false" \
            --port=2053
          kubectl wait --for=condition=ready pod/xui-test -n test-vpn --timeout=120s

      - name: ğŸ§ª Test endpoint
        run: |
          kubectl exec -n test-vpn xui-test -- curl -f http://localhost:2053/ -m 5
          echo "âœ… Liveness probe works!"

  test-pvc-mount:
    name: ğŸ’¾ PVC Mount Test
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build image
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Setup KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster-pvc
          version: v0.20.0

      - name: ğŸš€ Deploy with PVC
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster-pvc
          kubectl create namespace test-vpn
          
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc
            namespace: test-vpn
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
          ---
          apiVersion: v1
          kind: Pod
          metadata:
            name: xui-pvc-test
            namespace: test-vpn
          spec:
            containers:
            - name: xui
              image: ${{ env.IMAGE_NAME }}
              imagePullPolicy: Never
              volumeMounts:
              - name: data
                mountPath: /etc/x-ui
              securityContext:
                runAsUser: 2000
                runAsGroup: 2000
            volumes:
            - name: data
              persistentVolumeClaim:
                claimName: test-pvc
          EOF
          
          kubectl wait --for=condition=ready pod/xui-pvc-test -n test-vpn --timeout=120s

      - name: ğŸ’¾ Test PVC
        run: |
          kubectl exec -n test-vpn xui-pvc-test -- touch /etc/x-ui/test-write.txt
          OWNER=$(kubectl exec -n test-vpn xui-pvc-test -- stat -c '%U:%G' /etc/x-ui)
          
          if [ "$OWNER" != "x-ui:x-ui" ]; then
            echo "âŒ PVC owner incorrect: $OWNER"
            exit 1
          fi
          
          echo "âœ… PVC mount OK!"

  test-persistence:
    name: ğŸ”„ Persistence Test
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build image
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Setup KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster-persist
          version: v0.20.0

      - name: ğŸš€ Deploy StatefulSet
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster-persist
          kubectl create namespace test-vpn
          
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            clusterIP: None
            selector:
              app: xui
            ports:
            - port: 2053
          ---
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            serviceName: xui
            replicas: 1
            selector:
              matchLabels:
                app: xui
            template:
              metadata:
                labels:
                  app: xui
              spec:
                containers:
                - name: xui
                  image: ${{ env.IMAGE_NAME }}
                  imagePullPolicy: Never
                  volumeMounts:
                  - name: data
                    mountPath: /etc/x-ui
                  securityContext:
                    runAsUser: 2000
                    runAsGroup: 2000
            volumeClaimTemplates:
            - metadata:
                name: data
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 1Gi
          EOF
          
          kubectl wait --for=condition=ready pod -l app=xui -n test-vpn --timeout=180s

      - name: ğŸ”„ Test persistence
        run: |
          POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          TIMESTAMP=$(date +%s)
          kubectl exec -n test-vpn $POD -- sh -c "echo $TIMESTAMP > /etc/x-ui/persist-test.txt"
          
          kubectl delete pod -n test-vpn $POD --wait=true
          kubectl wait --for=condition=ready pod -l app=xui -n test-vpn --timeout=180s
          
          NEW_POD=$(kubectl get pod -n test-vpn -l app=xui -o jsonpath='{.items[0].metadata.name}')
          STORED=$(kubectl exec -n test-vpn $NEW_POD -- cat /etc/x-ui/persist-test.txt)
          
          if [ "$STORED" != "$TIMESTAMP" ]; then
            echo "âŒ Persistence failed!"
            exit 1
          fi
          
          echo "âœ… Persistence verified!"

  test-security-context:
    name: ğŸ”’ SecurityContext Test
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build image
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Setup KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster-security
          version: v0.20.0

      - name: ğŸš€ Quick deploy
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster-security
          kubectl create namespace test-vpn
          kubectl run xui-security-test -n test-vpn --image=${{ env.IMAGE_NAME }} \
            --image-pull-policy=Never \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "xui-security-test",
                  "image": "'${{ env.IMAGE_NAME }}'",
                  "securityContext": {
                    "runAsUser": 2000,
                    "runAsGroup": 2000,
                    "allowPrivilegeEscalation": false
                  }
                }]
              }
            }'
          kubectl wait --for=condition=ready pod/xui-security-test -n test-vpn --timeout=120s

      - name: ğŸ”’ Test security
        run: |
          UID=$(kubectl exec -n test-vpn xui-security-test -- id -u)
          GID=$(kubectl exec -n test-vpn xui-security-test -- id -g)
          
          if [ "$UID" != "2000" ] || [ "$GID" != "2000" ]; then
            echo "âŒ Wrong UID/GID: $UID:$GID"
            exit 1
          fi
          
          echo "âœ… SecurityContext OK!"

  test-service-connectivity:
    name: ğŸŒ Service Test
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build image
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Setup KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster-service
          version: v0.20.0

      - name: ğŸš€ Deploy with Service
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster-service
          kubectl create namespace test-vpn
          
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: xui-service-test
            namespace: test-vpn
            labels:
              app: xui
          spec:
            containers:
            - name: xui
              image: ${{ env.IMAGE_NAME }}
              imagePullPolicy: Never
              ports:
              - containerPort: 2053
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: xui
            namespace: test-vpn
          spec:
            selector:
              app: xui
            ports:
            - port: 2053
              targetPort: 2053
          EOF
          
          kubectl wait --for=condition=ready pod/xui-service-test -n test-vpn --timeout=120s

      - name: ğŸŒ Test service
        run: |
          kubectl run -n test-vpn test-client --image=busybox:1.36 --rm -it --restart=Never \
            -- wget -O- http://xui.test-vpn.svc.cluster.local:2053/ --timeout=10
          
          echo "âœ… Service connectivity OK!"

  test-logs-and-status:
    name: ğŸ“Š Logs & Status
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    if: always()
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build image
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: ğŸ¯ Setup KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster-logs
          version: v0.20.0

      - name: ğŸš€ Quick deploy
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }} --name test-cluster-logs
          kubectl create namespace test-vpn
          kubectl run xui-logs-test -n test-vpn --image=${{ env.IMAGE_NAME }} \
            --image-pull-policy=Never
          kubectl wait --for=condition=ready pod/xui-logs-test -n test-vpn --timeout=120s

      - name: ğŸ“Š Collect metrics
        run: |
          echo "## ğŸ“Š Pod Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n test-vpn -o wide >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“œ Pod Logs" >> $GITHUB_STEP_SUMMARY
          kubectl logs -n test-vpn xui-logs-test --tail=30 >> $GITHUB_STEP_SUMMARY || echo "No logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ” Pod Description" >> $GITHUB_STEP_SUMMARY
          kubectl describe pod -n test-vpn xui-logs-test >> $GITHUB_STEP_SUMMARY
