name: "ðŸ”’ Security Scanning Suite"

on:
  workflow_run:
    workflows: ["âš¡ Critical Path: Build & Runtime Tests"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  security-events: write

env:
  IMAGE_NAME: test-image:local
  TRIVY_VERSION: 0.50.2
  GRYPE_VERSION: 0.75.0
  DOCKLE_VERSION: 0.4.15
  SYFT_VERSION: 1.4.0

jobs:
  download-image:
    name: 'Download Built Image'
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Download image artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: docker-image-${{ github.event.workflow_run.head_sha }}
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cache image for scans
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: image.tar.gz
          key: security-scan-image-${{ github.event.workflow_run.head_sha }}
      
      - name: Upload for parallel jobs
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: security-scan-image
          path: image.tar.gz
          retention-days: 1

  trivy-scan:
    name: 'Trivy - CVE Scan'
    needs: download-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Download cached image
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: security-scan-image
      
      - name: Load image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Cache Trivy DB
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: .trivy
          key: trivy-db-${{ github.run_id }}
          restore-keys: trivy-db-
      
      - name: Install Trivy with checksum
        run: |
          TRIVY_CHECKSUM="8db0ff3b44f54a0b8c74eb25e1aa2e75f4a426c9946e32215f01c0fb6a3c674b"
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${{ env.TRIVY_VERSION }}/trivy_${{ env.TRIVY_VERSION }}_Linux-64bit.tar.gz > trivy.tar.gz
          echo "${TRIVY_CHECKSUM}  trivy.tar.gz" | sha256sum --check --strict || exit 1
          tar xzf trivy.tar.gz
          sudo mv trivy /usr/local/bin/
          echo "âœ… Trivy installed and validated"
      
      - name: Scan image
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --format json \
            --output trivy-report.json \
            ${{ env.IMAGE_NAME }}
          
          trivy image \
            --severity HIGH,CRITICAL \
            --format table \
            ${{ env.IMAGE_NAME }} | tee trivy-output.txt
      
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@662472033e021d55d94146f66f6058822b0b39fd # v3.27.0
        with:
          sarif_file: trivy-report.sarif
          category: trivy
        continue-on-error: true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: trivy-results-${{ github.event.workflow_run.head_sha }}
          path: trivy-*.*
          retention-days: 30

  grype-scan:
    name: 'Grype - Vulnerability Scan'
    needs: download-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Download cached image
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: security-scan-image
      
      - name: Load image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Install Grype with checksum
        run: |
          GRYPE_CHECKSUM="f1c0ca6f211c6d75c96ec7b7ff7d3d2c87df04b5e6e51a98e5c07f5b6f39ffd3"
          wget -O- https://github.com/anchore/grype/releases/download/v${{ env.GRYPE_VERSION }}/grype_${{ env.GRYPE_VERSION }}_linux_amd64.tar.gz > grype.tar.gz
          echo "${GRYPE_CHECKSUM}  grype.tar.gz" | sha256sum --check --strict || exit 1
          tar xzf grype.tar.gz
          sudo mv grype /usr/local/bin/
          echo "âœ… Grype installed and validated"
      
      - name: Scan image
        run: |
          grype ${{ env.IMAGE_NAME }} \
            --output json \
            --file grype-report.json || true
          
          grype ${{ env.IMAGE_NAME }} \
            --output table | tee grype-output.txt || true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: grype-results-${{ github.event.workflow_run.head_sha }}
          path: grype-*.*
          retention-days: 30

  dockle-scan:
    name: 'Dockle - Docker Hardening'
    needs: download-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Download cached image
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: security-scan-image
      
      - name: Load image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Install Dockle with checksum
        run: |
          DOCKLE_CHECKSUM="6fa557d7de5da8f359c1dffc4c2bf93e4ae1c32cb4c099a28967e4f08f2ca056"
          wget -O- https://github.com/goodwithtech/dockle/releases/download/v${{ env.DOCKLE_VERSION }}/dockle_${{ env.DOCKLE_VERSION }}_Linux-64bit.tar.gz > dockle.tar.gz
          echo "${DOCKLE_CHECKSUM}  dockle.tar.gz" | sha256sum --check --strict || exit 1
          tar xzf dockle.tar.gz
          sudo mv dockle /usr/local/bin/
          echo "âœ… Dockle installed and validated"
      
      - name: Scan image
        run: |
          dockle --format json --output dockle-report.json ${{ env.IMAGE_NAME }} || true
          dockle ${{ env.IMAGE_NAME }} | tee dockle-output.txt || true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: dockle-results-${{ github.event.workflow_run.head_sha }}
          path: dockle-*.*
          retention-days: 30

  syft-sbom:
    name: 'Syft - SBOM Generation'
    needs: download-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Download cached image
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: security-scan-image
      
      - name: Load image
        run: gunzip -c image.tar.gz | docker load
      
      - name: Install Syft with checksum
        run: |
          SYFT_CHECKSUM="c96e6df19e6aeb0a33addf5b70b4f33a3c9e8e8b1e84b5a1f3e08e2f0c77c93d"
          wget -O- https://github.com/anchore/syft/releases/download/v${{ env.SYFT_VERSION }}/syft_${{ env.SYFT_VERSION }}_linux_amd64.tar.gz > syft.tar.gz
          echo "${SYFT_CHECKSUM}  syft.tar.gz" | sha256sum --check --strict || exit 1
          tar xzf syft.tar.gz
          sudo mv syft /usr/local/bin/
          echo "âœ… Syft installed and validated"
      
      - name: Generate SBOM
        run: |
          syft ${{ env.IMAGE_NAME }} -o spdx-json > sbom.spdx.json || true
          syft ${{ env.IMAGE_NAME }} -o cyclonedx-json > sbom.cyclonedx.json || true
          syft ${{ env.IMAGE_NAME }} -o table | tee sbom-output.txt || true
      
      - name: Upload SBOM
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sbom-${{ github.event.workflow_run.head_sha }}
          path: sbom*.*
          retention-days: 90

  security-summary:
    name: 'ðŸ”’ Security Summary'
    needs: [trivy-scan, grype-scan, dockle-scan, syft-sbom]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      
      - name: Generate security report
        run: |
          echo "# ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          TRIVY="${{ needs.trivy-scan.result }}"
          GRYPE="${{ needs.grype-scan.result }}"
          DOCKLE="${{ needs.dockle-scan.result }}"
          SYFT="${{ needs.syft-sbom.result }}"
          
          [ "$TRIVY" = "success" ] && echo "| Trivy | âœ… COMPLETED |" >> $GITHUB_STEP_SUMMARY || echo "| Trivy | âš ï¸  ISSUES FOUND |" >> $GITHUB_STEP_SUMMARY
          [ "$GRYPE" = "success" ] && echo "| Grype | âœ… COMPLETED |" >> $GITHUB_STEP_SUMMARY || echo "| Grype | âš ï¸  ISSUES FOUND |" >> $GITHUB_STEP_SUMMARY
          [ "$DOCKLE" = "success" ] && echo "| Dockle | âœ… COMPLETED |" >> $GITHUB_STEP_SUMMARY || echo "| Dockle | âš ï¸  ISSUES FOUND |" >> $GITHUB_STEP_SUMMARY
          [ "$SYFT" = "success" ] && echo "| SBOM | âœ… COMPLETED |" >> $GITHUB_STEP_SUMMARY || echo "| SBOM | âš ï¸  ISSUES FOUND |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **Detailed reports available in artifacts**" >> $GITHUB_STEP_SUMMARY
          
          # Parse Trivy report if exists
          if [ -f "trivy-results-${{ github.event.workflow_run.head_sha }}/trivy-report.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results-*/trivy-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results-*/trivy-report.json 2>/dev/null || echo "0")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Trivy Findings" >> $GITHUB_STEP_SUMMARY
            echo "- **CRITICAL**: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- **HIGH**: $HIGH" >> $GITHUB_STEP_SUMMARY
          fi
