name: "ðŸ“‹ Unified CI/CD Reporting with CTRF"

on:
  workflow_run:
    workflows:
      - "âš¡ Critical Path: Build & Runtime Tests"
      - "ðŸ“Š Static Analysis & Best Practices"
      - "ðŸ”’ Security Scanning Suite"
    types: [completed]

concurrency:
  group: report-${{ github.ref }}
  cancel-in-progress: false

jobs:
  unified-report:
    name: 'ðŸ“‹ Unified CI Test Report (CTRF)'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all test artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          path: ./artifacts
      
      - name: Find CTRF test reports
        id: find-reports
        run: |
          mkdir -p ./ctrf
          find ./artifacts -type f -name '*.json' -exec cp {} ./ctrf/ \;
          count=$(ls ./ctrf/*.json 2>/dev/null | wc -l)
          echo "found=$count" >> $GITHUB_OUTPUT
      
      - name: Publish Unified Test Report (CTRF)
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: './ctrf/*.json'
          summary-report: true
          pull-request: true
          status-check: true
          ai-report: true
          flaky-report: true
          failed-report: true
          insights-report: true
          annotate: true
          report-order: 'summary-report,failed-report,flaky-report,ai-report,insights-report'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ steps.find-reports.outputs.found != '0' }}
      
      - name: No reports found fallback
        if: ${{ steps.find-reports.outputs.found == '0' }}
        run: |
          echo "## ðŸ“‹ Unified CI Test Report\n\n**No CTRF test reports (.json) found in workflow artifacts.**\n\nAdd generation of CTRF/junit/pytest/mocha/etc reports to your test jobs!" >> $GITHUB_STEP_SUMMARY
