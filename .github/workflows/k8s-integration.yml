name: ðŸš¦ Kubernetes Integration Test (Optimized)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: artur7892988/3xui-k8s-statefulset
  DOCKER_BUILDKIT: 1

jobs:
  k8sintegration:
    name: ðŸš¦ Kubernetes Integration Test (Optimized)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Save KIND cluster config
        run: |
          cat <<EOF > kind-config.yaml
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
              extraMounts:
                - hostPath: /tmp/k8s-test-pv
                  containerPath: /tmp/hostpath-provisioner
            - role: worker
          EOF
      - name: Install & Start KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: v0.20.0
          config: kind-config.yaml
          wait: 60s
          verbosity: 0
          kubectl_version: v1.31.4
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:integration .
      - name: Load image to KIND
        run: |
          kind load docker-image $IMAGE_NAME:integration --name test-cluster
      - name: Deploy to KIND (Helm or Kubectl)
        run: |
          kubectl version
          # helm upgrade --install ... Ð¸Ð»Ð¸ kubectl apply ... (Ð¿Ð¾ Ñ‚Ð²Ð¾ÐµÐ¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸)
      - name: ðŸš¨ Probe, Phase & Events Check
        run: |
          kubectl get pods -A -o json | jq '.items[] | {name: .metadata.name, ns: .metadata.namespace, phase: .status.phase, probes: ([.spec.containers[].livenessProbe] + [.spec.containers[].readinessProbe]) }' > logs/pod-probes.json
          kubectl get pods -A --field-selector=status.phase!=Running > logs/pods-nonrunning.txt
          kubectl get events --sort-by=.metadata.creationTimestamp > logs/k8s-events.txt
          kubectl describe pods -A > logs/pods-describe.txt
      - name: ðŸ”’ CIS Security Benchmark (kube-bench)
        run: |
          docker run --rm -v ~/.kube:/root/.kube aquasec/kube-bench:latest --benchmark cis-1.24 | tee logs/kube-bench.txt || true
      - name: ðŸŽ¯ Polaris Best Practices Check
        run: |
          docker run --rm -v ~/.kube:/root/.kube:ro quay.io/fairwinds/polaris:latest audit --format=pretty > logs/polaris-audit.txt || true
      - name: âœ… Kubeconform YAML Validation
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.6/kubeconform-linux-amd64.tar.gz | tar xz
          ./kubeconform -summary k8s/*.yaml > logs/kubeconform.txt || true
      - name: âš ï¸ Pluto Deprecated API Check
        run: |
          curl -L https://github.com/FairwindsOps/pluto/releases/download/v5.19.0/pluto_5.19.0_linux_amd64.tar.gz | tar xz
          ./pluto detect-files -d k8s/ > logs/pluto-deprecated.txt || true
          ./pluto detect-helm -o wide > logs/pluto-helm.txt || true
      - name: ðŸ” Checkov IaC Security Scan
        run: |
          docker run --rm -v $(pwd):/tf bridgecrew/checkov -d /tf/k8s --output cli > logs/checkov.txt || true
      - name: ðŸ›¡ï¸ Manifest Security Check (kubesec)
        run: |
          for f in k8s/*.yaml; do curl -sSX POST --data-binary @$f https://v2.kubesec.io/scan/ >> logs/kubesec-scan.txt; done || true
      - name: ðŸ—„ï¸ PV/PVC Storage Check
        run: |
          kubectl get pv,pvc -A > logs/pv-pvc.txt
      - name: ðŸŒ Service Connectivity (netshoot)
        run: |
          kubectl run netshoot --rm -i --tty --image=nicolaka/netshoot -- ping google.com | tee logs/netshoot.txt
      - name: ðŸ“ Container Resources
        run: |
          kubectl get pods -A -o json | jq '.items[] | {containers: [.spec.containers[].resources]}' > logs/container-resources.json
      - name: ðŸš« Privileged Container Check
        run: |
          (kubectl get pods -A -o json | jq '.items[] | select(.spec.containers[].securityContext.runAsUser==0)') > logs/privileged-containers.txt || true
      - name: ðŸ“¦ Helm Chart Lint
        run: |
          helm lint ./charts/* > logs/helm-lint.txt || true
      - name: ðŸ“Š Resource Quotas & Limit Ranges
        run: |
          kubectl get resourcequota,limitrange -A > logs/quotas-limits.txt || true
      - name: ðŸš€ Custom Integration/Smoke Test (Testkube / curl)
        run: |
          echo "Testkube API smoke test" > logs/testkube.txt
      - name: Collect pod/container logs
        run: |
          mkdir -p logs
          kubectl get pods -A -o wide > logs/pods.txt
          kubectl logs --all-containers --prefix -A > logs/all-containers.log || true
      - name: ðŸ“Š Generate Test Report Dashboard
        run: |
          cat <<EOF > logs/dashboard.html
          <!DOCTYPE html>
          <html><head><title>K8s Test Report</title></head>
          <body>
          <h1>Kubernetes Integration Test Results</h1>
          <pre>$(cat logs/*.txt)</pre>
          </body></html>
          EOF
      - name: Upload all integration test logs
        uses: actions/upload-artifact@v4
        with:
          name: k8s-integration-logs
          path: logs/
      - name: Success notification
        if: success()
        run: echo 'Kubernetes Integration Test (Optimized) â€” SUCCESS'
