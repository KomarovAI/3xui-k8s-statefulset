name: üöÄ Kubernetes Integration & Security Testing (2025 Best Practices)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1' # Weekly security scan

env:
  IMAGE_NAME: artur7892988/3xui-k8s-statefulset
  DOCKER_BUILDKIT: 1
  KUBE_VERSION: v1.31.4
  KIND_VERSION: v0.20.0

jobs:
  # ==================== STAGE 1: BUILD & SCAN ====================
  build-and-scan:
    name: üèóÔ∏è Build & Security Scan
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      has-errors: ${{ steps.error-check.outputs.has-errors }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Create logs directory
        run: mkdir -p logs errors
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }},${{ env.IMAGE_NAME }}:latest
          outputs: type=docker,dest=/tmp/image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true
      
      - name: Load image
        run: docker load --input /tmp/image.tar || true
      
      # üîí Trivy - Vulnerability Scanning (GitHub Action)
      - name: üîí Trivy - Container Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true
          
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Trivy - JSON Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'json'
          output: 'logs/trivy-image.json'
        continue-on-error: true
      
      # üì¶ SBOM Generation with Syft
      - name: üì¶ Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: spdx-json
          output-file: logs/sbom.spdx.json
        continue-on-error: true
      
      # üîê Grype - SBOM Vulnerability Scanning
      - name: üîê Grype - SBOM Vulnerability Scan
        uses: anchore/scan-action@v3
        with:
          sbom: logs/sbom.spdx.json
          fail-build: false
          output-format: json
          severity-cutoff: medium
        continue-on-error: true
      
      # Extract errors from this stage
      - name: üìä Extract Build Stage Errors
        if: always()
        run: |
          cat > errors/build-errors.json <<'EOF'
          {
            "stage": "build-and-scan",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "errors": []
          }
          EOF
          
          # Check Trivy results
          if [ -f "logs/trivy-image.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' logs/trivy-image.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' logs/trivy-image.json 2>/dev/null || echo "0")
            
            if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
              jq --arg critical "$CRITICAL" --arg high "$HIGH" \
                '.errors += [{
                  "category": "container-security",
                  "severity": "CRITICAL",
                  "tool": "Trivy",
                  "message": "Found \($critical) CRITICAL and \($high) HIGH vulnerabilities in container image",
                  "recommendation": "Review logs/trivy-image.json and update vulnerable dependencies"
                }]' errors/build-errors.json > errors/build-errors.tmp && mv errors/build-errors.tmp errors/build-errors.json
            fi
          fi
          
          # Check build status
          if [ "${{ steps.build.outcome }}" == "failure" ]; then
            jq '.errors += [{
              "category": "build",
              "severity": "CRITICAL",
              "tool": "Docker Build",
              "message": "Docker image build failed",
              "recommendation": "Check Dockerfile syntax and build context"
            }]' errors/build-errors.json > errors/build-errors.tmp && mv errors/build-errors.tmp errors/build-errors.json
          fi
      
      - name: Check for errors
        id: error-check
        if: always()
        run: |
          ERROR_COUNT=$(jq '.errors | length' errors/build-errors.json 2>/dev/null || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Save image artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1
      
      - name: Save scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-scan-results
          path: |
            logs/
            errors/

  # ==================== STAGE 2: MANIFEST VALIDATION ====================
  manifest-validation:
    name: üìã Manifest Validation & Policy Check
    runs-on: ubuntu-latest
    outputs:
      has-errors: ${{ steps.error-check.outputs.has-errors }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Create logs directory
        run: mkdir -p logs errors
      
      # ‚úÖ Kubeconform - YAML Schema Validation
      - name: ‚úÖ Kubeconform - YAML Validation
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.6/kubeconform-linux-amd64.tar.gz | tar xz
          ./kubeconform -summary -output json k8s/*.yaml > logs/kubeconform.json 2>&1 || true
          cat logs/kubeconform.json
        continue-on-error: true
      
      # ‚ö†Ô∏è Pluto - Deprecated API Detection
      - name: ‚ö†Ô∏è Pluto - Deprecated API Check
        run: |
          curl -L https://github.com/FairwindsOps/pluto/releases/download/v5.19.0/pluto_5.19.0_linux_amd64.tar.gz | tar xz
          ./pluto detect-files -d k8s/ -o wide > logs/pluto-deprecated.txt 2>&1 || true
          cat logs/pluto-deprecated.txt
        continue-on-error: true
      
      # üîê Checkov - IaC Security Scan
      - name: üîê Checkov - IaC Security Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: k8s/
          output_format: cli,json
          output_file_path: console,logs/checkov.json
          soft_fail: true
        continue-on-error: true
      
      # üõ°Ô∏è Kubesec - Manifest Security Scoring
      - name: üõ°Ô∏è Kubesec - Security Risk Analysis
        run: |
          for f in k8s/*.yaml; do 
            echo "Scanning $f..."
            curl -sSX POST --data-binary @$f https://v2.kubesec.io/scan/ | tee -a logs/kubesec-scan.json
            echo "" >> logs/kubesec-scan.json
          done || true
        continue-on-error: true
      
      # üéØ Kyverno CLI - Policy Validation (Dry-run)
      - name: üéØ Kyverno - Policy Validation
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/download/v1.11.4/kyverno-cli_v1.11.4_linux_x86_64.tar.gz
          tar -xzf kyverno-cli_v1.11.4_linux_x86_64.tar.gz
          
          # Apply best practice policies
          ./kyverno apply policies/kyverno/ --resource k8s/ > logs/kyverno-validation.txt 2>&1 || true
          cat logs/kyverno-validation.txt
        continue-on-error: true
      
      # üì¶ Helm Lint
      - name: üì¶ Helm Chart Validation
        run: |
          if [ -d "charts" ]; then
            helm lint ./charts/* > logs/helm-lint.txt 2>&1 || true
            cat logs/helm-lint.txt
          else
            echo "No Helm charts found" > logs/helm-lint.txt
          fi
        continue-on-error: true
      
      # Extract errors from this stage
      - name: üìä Extract Validation Stage Errors
        if: always()
        run: |
          cat > errors/validation-errors.json <<'EOF'
          {
            "stage": "manifest-validation",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "errors": []
          }
          EOF
          
          # Check Kubeconform
          if [ -f "logs/kubeconform.json" ]; then
            INVALID=$(jq '.summary.invalid // 0' logs/kubeconform.json 2>/dev/null || echo "0")
            if [ "$INVALID" -gt "0" ]; then
              jq --arg count "$INVALID" '.errors += [{
                "category": "yaml-validation",
                "severity": "HIGH",
                "tool": "Kubeconform",
                "message": "\($count) manifests failed schema validation",
                "recommendation": "Review logs/kubeconform.json for detailed validation errors"
              }]' errors/validation-errors.json > errors/validation-errors.tmp && mv errors/validation-errors.tmp errors/validation-errors.json
            fi
          fi
          
          # Check Pluto for deprecated APIs
          if [ -f "logs/pluto-deprecated.txt" ] && grep -q "DEPRECATED" logs/pluto-deprecated.txt; then
            DEPRECATED_COUNT=$(grep -c "DEPRECATED" logs/pluto-deprecated.txt || echo "0")
            jq --arg count "$DEPRECATED_COUNT" '.errors += [{
              "category": "deprecated-api",
              "severity": "MEDIUM",
              "tool": "Pluto",
              "message": "\($count) deprecated Kubernetes APIs detected",
              "recommendation": "Update manifests to use current API versions. See logs/pluto-deprecated.txt"
            }]' errors/validation-errors.json > errors/validation-errors.tmp && mv errors/validation-errors.tmp errors/validation-errors.json
          fi
          
          # Check Checkov
          if [ -f "logs/checkov.json" ]; then
            FAILED=$(jq '.summary.failed // 0' logs/checkov.json 2>/dev/null || echo "0")
            if [ "$FAILED" -gt "0" ]; then
              jq --arg count "$FAILED" '.errors += [{
                "category": "iac-security",
                "severity": "HIGH",
                "tool": "Checkov",
                "message": "\($count) IaC security checks failed",
                "recommendation": "Review logs/checkov.json and fix security misconfigurations"
              }]' errors/validation-errors.json > errors/validation-errors.tmp && mv errors/validation-errors.tmp errors/validation-errors.json
            fi
          fi
          
          # Check Kyverno policies
          if [ -f "logs/kyverno-validation.txt" ] && grep -q "fail" logs/kyverno-validation.txt; then
            POLICY_FAILS=$(grep -c "fail" logs/kyverno-validation.txt || echo "0")
            jq --arg count "$POLICY_FAILS" '.errors += [{
              "category": "policy-violation",
              "severity": "MEDIUM",
              "tool": "Kyverno",
              "message": "\($count) policy violations detected",
              "recommendation": "Review logs/kyverno-validation.txt and ensure compliance with policies"
            }]' errors/validation-errors.json > errors/validation-errors.tmp && mv errors/validation-errors.tmp errors/validation-errors.json
          fi
      
      - name: Check for errors
        id: error-check
        if: always()
        run: |
          ERROR_COUNT=$(jq '.errors | length' errors/validation-errors.json 2>/dev/null || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: manifest-validation-results
          path: |
            logs/
            errors/

  # ==================== STAGE 3: CLUSTER DEPLOYMENT ====================
  k8s-deployment:
    name: üö¶ K8s Cluster Deployment
    runs-on: ubuntu-latest
    needs: [build-and-scan, manifest-validation]
    if: success() || failure()
    outputs:
      has-errors: ${{ steps.error-check.outputs.has-errors }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Create logs directory
        run: mkdir -p logs errors
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
        continue-on-error: true
      
      - name: Create KIND config
        run: |
          cat <<EOF > kind-config.yaml
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
              kubeadmConfigPatches:
              - |
                kind: InitConfiguration
                nodeRegistration:
                  kubeletExtraArgs:
                    node-labels: "ingress-ready=true"
              extraPortMappings:
              - containerPort: 80
                hostPort: 80
                protocol: TCP
              - containerPort: 443
                hostPort: 443
                protocol: TCP
              extraMounts:
                - hostPath: /tmp/k8s-test-pv
                  containerPath: /tmp/hostpath-provisioner
            - role: worker
              extraMounts:
                - hostPath: /tmp/k8s-test-pv-worker
                  containerPath: /tmp/hostpath-provisioner
          EOF
      
      - name: Install & Start KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: ${{ env.KIND_VERSION }}
          config: kind-config.yaml
          wait: 90s
          kubectl_version: ${{ env.KUBE_VERSION }}
        continue-on-error: true
      
      - name: Load Docker image to KIND
        run: |
          docker load --input /tmp/image.tar || true
          kind load docker-image ${{ env.IMAGE_NAME }}:${{ github.sha }} --name test-cluster || true
        continue-on-error: true
      
      - name: Install Kyverno (Policy Engine)
        run: |
          helm repo add kyverno https://kyverno.github.io/kyverno/
          helm repo update
          helm install kyverno kyverno/kyverno \
            --namespace kyverno \
            --create-namespace \
            --set replicaCount=1 \
            --wait --timeout 300s || true
          
          # Install Kyverno policies
          kubectl apply -f https://raw.githubusercontent.com/kyverno/policies/main/pod-security/restricted/disallow-privilege-escalation/disallow-privilege-escalation.yaml || true
          kubectl apply -f https://raw.githubusercontent.com/kyverno/policies/main/best-practices/require-labels/require-labels.yaml || true
          kubectl apply -f https://raw.githubusercontent.com/kyverno/policies/main/best-practices/require-resource-requests/require-resource-requests.yaml || true
        continue-on-error: true
      
      - name: Deploy Application
        run: |
          # Update image tag in manifests
          find k8s/ -name "*.yaml" -exec sed -i "s|image:.*$IMAGE_NAME.*|image: $IMAGE_NAME:${{ github.sha }}|g" {} \;
          
          # Apply manifests
          kubectl create namespace 3xui-test || true
          kubectl apply -f k8s/ -n 3xui-test || true
          
          # Wait for deployment
          kubectl wait --for=condition=ready pod -l app=3xui -n 3xui-test --timeout=300s || true
        continue-on-error: true
      
      - name: Verify deployment
        if: always()
        run: |
          kubectl get all -n 3xui-test -o wide | tee logs/deployment-status.txt || true
          kubectl get pods -n 3xui-test -o json | jq '.items[] | {name: .metadata.name, phase: .status.phase, conditions: .status.conditions}' | tee logs/pod-details.json || true
        continue-on-error: true
      
      # Extract deployment errors
      - name: üìä Extract Deployment Errors
        if: always()
        run: |
          cat > errors/deployment-errors.json <<'EOF'
          {
            "stage": "k8s-deployment",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "errors": []
          }
          EOF
          
          # Check pod status
          if [ -f "logs/pod-details.json" ]; then
            NOT_RUNNING=$(jq '[.[] | select(.phase != "Running")] | length' logs/pod-details.json 2>/dev/null || echo "0")
            if [ "$NOT_RUNNING" -gt "0" ]; then
              jq --arg count "$NOT_RUNNING" '.errors += [{
                "category": "deployment",
                "severity": "CRITICAL",
                "tool": "kubectl",
                "message": "\($count) pods are not in Running state",
                "recommendation": "Check logs/pod-details.json and kubectl describe pods for failure reasons"
              }]' errors/deployment-errors.json > errors/deployment-errors.tmp && mv errors/deployment-errors.tmp errors/deployment-errors.json
            fi
          fi
      
      - name: Check for errors
        id: error-check
        if: always()
        run: |
          ERROR_COUNT=$(jq '.errors | length' errors/deployment-errors.json 2>/dev/null || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload deployment logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-results
          path: |
            logs/
            errors/

  # ==================== STAGE 4: RUNTIME SECURITY & COMPLIANCE ====================
  runtime-security:
    name: üîí Runtime Security & Compliance
    runs-on: ubuntu-latest
    needs: k8s-deployment
    if: success() || failure()
    outputs:
      has-errors: ${{ steps.error-check.outputs.has-errors }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install & Start KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: ${{ env.KIND_VERSION }}
          kubectl_version: ${{ env.KUBE_VERSION }}
        continue-on-error: true
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
        continue-on-error: true
      
      - name: Load image and deploy
        run: |
          docker load --input /tmp/image.tar || true
          kind load docker-image ${{ env.IMAGE_NAME }}:${{ github.sha }} --name test-cluster || true
          kubectl create namespace 3xui-test || true
          find k8s/ -name "*.yaml" -exec sed -i "s|image:.*$IMAGE_NAME.*|image: $IMAGE_NAME:${{ github.sha }}|g" {} \;
          kubectl apply -f k8s/ -n 3xui-test || true
          sleep 30
        continue-on-error: true
      
      - name: Create logs directory
        run: mkdir -p logs errors
      
      # üö® CIS Benchmark with kube-bench
      - name: üö® CIS Kubernetes Benchmark (kube-bench)
        run: |
          docker pull aquasec/kube-bench:latest
          docker run --rm --pid=host \
            -v /etc:/etc:ro \
            -v /var:/var:ro \
            -v $(which kubectl):/usr/local/bin/kubectl:ro \
            -v ~/.kube:/root/.kube:ro \
            aquasec/kube-bench:latest \
            --benchmark cis-1.24 --json | tee logs/kube-bench.json || true
        continue-on-error: true
      
      # üéØ Polaris - Best Practices Audit
      - name: üéØ Polaris - Configuration Audit
        run: |
          kubectl apply -f https://github.com/FairwindsOps/polaris/releases/latest/download/dashboard.yaml || true
          sleep 10
          kubectl port-forward -n polaris svc/polaris-dashboard 8080:80 &
          sleep 5
          curl http://localhost:8080/health || true
          
          # CLI audit
          docker run --rm \
            -v ~/.kube:/root/.kube:ro \
            quay.io/fairwinds/polaris:latest \
            audit --format=json --kubeconfig /root/.kube/config \
            > logs/polaris-audit.json 2>&1 || true
        continue-on-error: true
      
      # üõ°Ô∏è Falco - Runtime Security Monitoring
      - name: üõ°Ô∏è Falco - Runtime Threat Detection
        run: |
          helm repo add falcosecurity https://falcosecurity.github.io/charts
          helm repo update
          helm install falco falcosecurity/falco \
            --namespace falco \
            --create-namespace \
            --set falco.grpc.enabled=true \
            --set falco.grpcOutput.enabled=true \
            --wait --timeout 180s || true
          
          # Collect Falco events
          sleep 30
          kubectl logs -n falco -l app.kubernetes.io/name=falco --tail=100 > logs/falco-events.txt 2>&1 || true
        continue-on-error: true
      
      # üìä Resource Analysis
      - name: üìä Pod Resource Analysis
        if: always()
        run: |
          kubectl get pods -A -o json | jq '.items[] | {
            name: .metadata.name, 
            namespace: .metadata.namespace,
            phase: .status.phase,
            resources: .spec.containers[].resources,
            securityContext: .spec.containers[].securityContext
          }' > logs/pod-resources.json || true
          
          # Check for privileged containers
          kubectl get pods -A -o json | \
            jq '[.items[] | select(.spec.containers[].securityContext.privileged==true or .spec.containers[].securityContext.runAsUser==0)]' \
            > logs/privileged-containers.json || echo "[]" > logs/privileged-containers.json
        continue-on-error: true
      
      # üåê Network Policy Check
      - name: üåê Network Policy Validation
        if: always()
        run: |
          kubectl get networkpolicies -A -o yaml > logs/network-policies.yaml || echo "No NetworkPolicies found" > logs/network-policies.yaml
        continue-on-error: true
      
      # Extract security errors
      - name: üìä Extract Security Errors
        if: always()
        run: |
          cat > errors/security-errors.json <<'EOF'
          {
            "stage": "runtime-security",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "errors": []
          }
          EOF
          
          # Check CIS Benchmark
          if [ -f "logs/kube-bench.json" ]; then
            FAILS=$(jq '[.Controls[]?.tests[]?.results[]? | select(.status=="FAIL")] | length' logs/kube-bench.json 2>/dev/null || echo "0")
            if [ "$FAILS" -gt "0" ]; then
              jq --arg count "$FAILS" '.errors += [{
                "category": "compliance",
                "severity": "HIGH",
                "tool": "kube-bench",
                "message": "\($count) CIS Benchmark checks failed",
                "recommendation": "Review logs/kube-bench.json and remediate CIS failures"
              }]' errors/security-errors.json > errors/security-errors.tmp && mv errors/security-errors.tmp errors/security-errors.json
            fi
          fi
          
          # Check Polaris
          if [ -f "logs/polaris-audit.json" ]; then
            DANGERS=$(jq '[.Results[]? | select(.PodResult?.Results? | to_entries[] | .value.severity=="danger")] | length' logs/polaris-audit.json 2>/dev/null || echo "0")
            if [ "$DANGERS" -gt "0" ]; then
              jq --arg count "$DANGERS" '.errors += [{
                "category": "best-practices",
                "severity": "MEDIUM",
                "tool": "Polaris",
                "message": "\($count) dangerous configuration issues found",
                "recommendation": "Review logs/polaris-audit.json and fix configuration violations"
              }]' errors/security-errors.json > errors/security-errors.tmp && mv errors/security-errors.tmp errors/security-errors.json
            fi
          fi
          
          # Check privileged containers
          if [ -f "logs/privileged-containers.json" ]; then
            PRIV_COUNT=$(jq 'length' logs/privileged-containers.json 2>/dev/null || echo "0")
            if [ "$PRIV_COUNT" -gt "0" ]; then
              jq --arg count "$PRIV_COUNT" '.errors += [{
                "category": "security-context",
                "severity": "CRITICAL",
                "tool": "kubectl",
                "message": "\($count) privileged or root containers detected",
                "recommendation": "Remove privileged mode and set runAsNonRoot: true"
              }]' errors/security-errors.json > errors/security-errors.tmp && mv errors/security-errors.tmp errors/security-errors.json
            fi
          fi
      
      - name: Check for errors
        id: error-check
        if: always()
        run: |
          ERROR_COUNT=$(jq '.errors | length' errors/security-errors.json 2>/dev/null || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: runtime-security-results
          path: |
            logs/
            errors/

  # ==================== STAGE 5: INTEGRATION & E2E TESTING ====================
  integration-testing:
    name: üß™ Integration & E2E Testing
    runs-on: ubuntu-latest
    needs: k8s-deployment
    if: success() || failure()
    outputs:
      has-errors: ${{ steps.error-check.outputs.has-errors }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install & Start KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: ${{ env.KIND_VERSION }}
          kubectl_version: ${{ env.KUBE_VERSION }}
        continue-on-error: true
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
        continue-on-error: true
      
      - name: Load image and deploy
        run: |
          docker load --input /tmp/image.tar || true
          kind load docker-image ${{ env.IMAGE_NAME }}:${{ github.sha }} --name test-cluster || true
          kubectl create namespace 3xui-test || true
          find k8s/ -name "*.yaml" -exec sed -i "s|image:.*$IMAGE_NAME.*|image: $IMAGE_NAME:${{ github.sha }}|g" {} \;
          kubectl apply -f k8s/ -n 3xui-test || true
          kubectl wait --for=condition=ready pod -l app=3xui -n 3xui-test --timeout=300s || true
        continue-on-error: true
      
      - name: Create logs directory
        run: mkdir -p logs errors
      
      # üîå Service Connectivity Test
      - name: üîå Network Connectivity (netshoot)
        run: |
          kubectl run netshoot --rm -i --tty \
            --image=nicolaka/netshoot \
            --restart=Never \
            -- /bin/bash -c "ping -c 4 google.com && nslookup kubernetes.default" \
            2>&1 | tee logs/network-connectivity.txt || true
        continue-on-error: true
      
      # üåê Service Mesh Readiness
      - name: üåê Service Discovery Test
        if: always()
        run: |
          kubectl get svc -A -o wide | tee logs/services.txt || true
          kubectl get endpoints -A -o wide | tee logs/endpoints.txt || true
        continue-on-error: true
      
      # ‚ö° Application Health Checks
      - name: ‚ö° Application Health & Readiness
        if: always()
        run: |
          kubectl get pods -n 3xui-test -o json | jq '.items[] | {
            name: .metadata.name,
            ready: .status.conditions[] | select(.type=="Ready") | .status,
            restartCount: .status.containerStatuses[].restartCount,
            livenessProbe: .spec.containers[].livenessProbe,
            readinessProbe: .spec.containers[].readinessProbe
          }' > logs/health-checks.json || true
        continue-on-error: true
      
      # üì° API Endpoint Testing (if applicable)
      - name: üì° API Endpoint Smoke Tests
        run: |
          # Port-forward to service
          kubectl port-forward -n 3xui-test svc/3xui-service 8080:80 &
          PF_PID=$!
          sleep 10
          
          # Basic HTTP checks
          curl -v http://localhost:8080 > logs/api-smoke-test.txt 2>&1 || echo "API not accessible" > logs/api-smoke-test.txt
          
          kill $PF_PID 2>/dev/null || true
        continue-on-error: true
      
      # üóÑÔ∏è Persistent Volume Tests
      - name: üóÑÔ∏è Storage & PV/PVC Validation
        if: always()
        run: |
          kubectl get pv,pvc -A -o wide > logs/storage-status.txt || true
          kubectl describe pvc -n 3xui-test >> logs/storage-status.txt 2>&1 || true
        continue-on-error: true
      
      # üìã Event Analysis
      - name: üìã Kubernetes Events Analysis
        if: always()
        run: |
          kubectl get events -A --sort-by='.lastTimestamp' > logs/k8s-events.txt || true
          kubectl get events -n 3xui-test --field-selector type!=Normal > logs/warning-events.txt || echo "No warnings" > logs/warning-events.txt
        continue-on-error: true
      
      # Extract integration errors
      - name: üìä Extract Integration Errors
        if: always()
        run: |
          cat > errors/integration-errors.json <<'EOF'
          {
            "stage": "integration-testing",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "errors": []
          }
          EOF
          
          # Check health status
          if [ -f "logs/health-checks.json" ]; then
            NOT_READY=$(jq '[.[] | select(.ready != "True")] | length' logs/health-checks.json 2>/dev/null || echo "0")
            if [ "$NOT_READY" -gt "0" ]; then
              jq --arg count "$NOT_READY" '.errors += [{
                "category": "health-check",
                "severity": "HIGH",
                "tool": "kubectl",
                "message": "\($count) pods failed readiness checks",
                "recommendation": "Review logs/health-checks.json and pod logs"
              }]' errors/integration-errors.json > errors/integration-errors.tmp && mv errors/integration-errors.tmp errors/integration-errors.json
            fi
          fi
          
          # Check for warning events
          if [ -f "logs/warning-events.txt" ] && [ "$(wc -l < logs/warning-events.txt)" -gt "1" ]; then
            WARNING_COUNT=$(wc -l < logs/warning-events.txt)
            jq --arg count "$WARNING_COUNT" '.errors += [{
              "category": "cluster-events",
              "severity": "MEDIUM",
              "tool": "kubectl events",
              "message": "\($count) warning events detected",
              "recommendation": "Review logs/warning-events.txt for event details"
            }]' errors/integration-errors.json > errors/integration-errors.tmp && mv errors/integration-errors.tmp errors/integration-errors.json
          fi
      
      - name: Check for errors
        id: error-check
        if: always()
        run: |
          ERROR_COUNT=$(jq '.errors | length' errors/integration-errors.json 2>/dev/null || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            logs/
            errors/

  # ==================== STAGE 6: PERFORMANCE & CHAOS TESTING ====================
  performance-chaos:
    name: üöÄ Performance & Chaos Engineering
    runs-on: ubuntu-latest
    needs: k8s-deployment
    if: success() || failure()
    outputs:
      has-errors: ${{ steps.error-check.outputs.has-errors }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install & Start KIND
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: ${{ env.KIND_VERSION }}
          kubectl_version: ${{ env.KUBE_VERSION }}
        continue-on-error: true
      
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
        continue-on-error: true
      
      - name: Load image and deploy
        run: |
          docker load --input /tmp/image.tar || true
          kind load docker-image ${{ env.IMAGE_NAME }}:${{ github.sha }} --name test-cluster || true
          kubectl create namespace 3xui-test || true
          find k8s/ -name "*.yaml" -exec sed -i "s|image:.*$IMAGE_NAME.*|image: $IMAGE_NAME:${{ github.sha }}|g" {} \;
          kubectl apply -f k8s/ -n 3xui-test || true
          kubectl wait --for=condition=ready pod -l app=3xui -n 3xui-test --timeout=300s || true
        continue-on-error: true
      
      - name: Create logs directory
        run: mkdir -p logs errors
      
      # üìä k6 - Performance Testing
      - name: üìä k6 - Load Testing
        run: |
          # Create k6 test script
          cat <<'EOF' > loadtest.js
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          
          export let options = {
            stages: [
              { duration: '30s', target: 10 },
              { duration: '1m', target: 20 },
              { duration: '30s', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],
              http_req_failed: ['rate<0.1'],
            },
          };
          
          export default function () {
            const res = http.get('http://localhost:8080');
            check(res, { 'status is 200': (r) => r.status === 200 });
            sleep(1);
          }
          EOF
          
          # Port-forward
          kubectl port-forward -n 3xui-test svc/3xui-service 8080:80 &
          PF_PID=$!
          sleep 10
          
          # Run k6
          docker run --rm --network host \
            -v $(pwd):/scripts \
            grafana/k6 run /scripts/loadtest.js \
            --out json=/scripts/logs/k6-results.json \
            2>&1 | tee logs/k6-output.txt || true
          
          kill $PF_PID 2>/dev/null || true
        continue-on-error: true
      
      # üå™Ô∏è LitmusChaos - Chaos Engineering
      - name: üå™Ô∏è LitmusChaos - Resilience Testing
        run: |
          # Install Litmus
          kubectl apply -f https://litmuschaos.github.io/litmus/litmus-operator-v3.9.0.yaml || true
          sleep 30
          
          # Install pod-delete experiment
          kubectl apply -f https://hub.litmuschaos.io/api/chaos/master?file=charts/generic/pod-delete/experiment.yaml -n 3xui-test || true
          
          # Create ChaosEngine
          cat <<EOF | kubectl apply -f - || true
          apiVersion: litmuschaos.io/v1alpha1
          kind: ChaosEngine
          metadata:
            name: 3xui-chaos
            namespace: 3xui-test
          spec:
            appinfo:
              appns: 3xui-test
              applabel: 'app=3xui'
              appkind: 'deployment'
            engineState: 'active'
            chaosServiceAccount: litmus-admin
            experiments:
            - name: pod-delete
              spec:
                components:
                  env:
                  - name: TOTAL_CHAOS_DURATION
                    value: '30'
                  - name: CHAOS_INTERVAL
                    value: '10'
                  - name: FORCE
                    value: 'false'
          EOF
          
          sleep 60
          kubectl get chaosengine -n 3xui-test -o yaml > logs/chaos-results.yaml 2>&1 || true
          kubectl get chaosresult -n 3xui-test -o yaml >> logs/chaos-results.yaml 2>&1 || true
        continue-on-error: true
      
      # Extract performance errors
      - name: üìä Extract Performance Errors
        if: always()
        run: |
          cat > errors/performance-errors.json <<'EOF'
          {
            "stage": "performance-chaos",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "errors": []
          }
          EOF
          
          # Check k6 thresholds
          if [ -f "logs/k6-output.txt" ] && grep -q "threshold" logs/k6-output.txt; then
            THRESHOLD_FAILS=$(grep -c "‚úó" logs/k6-output.txt || echo "0")
            if [ "$THRESHOLD_FAILS" -gt "0" ]; then
              jq --arg count "$THRESHOLD_FAILS" '.errors += [{
                "category": "performance",
                "severity": "MEDIUM",
                "tool": "k6",
                "message": "\($count) performance thresholds exceeded",
                "recommendation": "Review logs/k6-output.txt and optimize application performance"
              }]' errors/performance-errors.json > errors/performance-errors.tmp && mv errors/performance-errors.tmp errors/performance-errors.json
            fi
          fi
      
      - name: Check for errors
        id: error-check
        if: always()
        run: |
          ERROR_COUNT=$(jq '.errors | length' errors/performance-errors.json 2>/dev/null || echo "0")
          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-chaos-results
          path: |
            logs/
            errors/

  # ==================== STAGE 7: ERROR AGGREGATION & FINAL REPORT ====================
  error-aggregation:
    name: üìä Error Aggregation & Final Report
    runs-on: ubuntu-latest
    needs: [build-and-scan, manifest-validation, k8s-deployment, runtime-security, integration-testing, performance-chaos]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all error artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
        continue-on-error: true
      
      - name: üéØ Aggregate All Errors
        run: |
          mkdir -p final-report
          
          # Combine all error files
          jq -s '.' all-results/*/errors/*.json 2>/dev/null > final-report/all-errors.json || echo "[]" > final-report/all-errors.json
          
          # Generate error summary
          cat > final-report/error-summary.json <<'EOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run": "${{ github.run_id }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "summary": {
              "total_errors": 0,
              "critical": 0,
              "high": 0,
              "medium": 0,
              "low": 0
            },
            "by_category": {},
            "by_stage": {},
            "by_tool": {},
            "all_errors": []
          }
          EOF
          
          # Process errors
          if [ -f "final-report/all-errors.json" ]; then
            # Count by severity
            CRITICAL=$(jq '[.[] | .errors[] | select(.severity=="CRITICAL")] | length' final-report/all-errors.json)
            HIGH=$(jq '[.[] | .errors[] | select(.severity=="HIGH")] | length' final-report/all-errors.json)
            MEDIUM=$(jq '[.[] | .errors[] | select(.severity=="MEDIUM")] | length' final-report/all-errors.json)
            LOW=$(jq '[.[] | .errors[] | select(.severity=="LOW")] | length' final-report/all-errors.json)
            TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
            
            # Update summary
            jq --arg total "$TOTAL" --arg critical "$CRITICAL" --arg high "$HIGH" --arg medium "$MEDIUM" --arg low "$LOW" \
              '.summary.total_errors = ($total | tonumber) |
               .summary.critical = ($critical | tonumber) |
               .summary.high = ($high | tonumber) |
               .summary.medium = ($medium | tonumber) |
               .summary.low = ($low | tonumber)' \
              final-report/error-summary.json > final-report/error-summary.tmp && mv final-report/error-summary.tmp final-report/error-summary.json
            
            # Group by category
            jq '[.[] | .errors[]] | group_by(.category) | map({(.[0].category): length}) | add' \
              final-report/all-errors.json > final-report/by-category.json
            
            # Group by stage
            jq 'group_by(.stage) | map({(.[0].stage): (.[] | .errors | length)}) | add' \
              final-report/all-errors.json > final-report/by-stage.json
            
            # Group by tool
            jq '[.[] | .errors[]] | group_by(.tool) | map({(.[0].tool): length}) | add' \
              final-report/all-errors.json > final-report/by-tool.json
            
            # Add grouped data to summary
            jq --slurpfile cat final-report/by-category.json \
               --slurpfile stage final-report/by-stage.json \
               --slurpfile tool final-report/by-tool.json \
               '.by_category = $cat[0] | .by_stage = $stage[0] | .by_tool = $tool[0]' \
              final-report/error-summary.json > final-report/error-summary.tmp && mv final-report/error-summary.tmp final-report/error-summary.json
            
            # Flatten all errors
            jq '[.[] | .errors[] | . + {stage: (.stage // "unknown")}]' \
              final-report/all-errors.json > final-report/errors-flat.json
            
            jq --slurpfile errors final-report/errors-flat.json '.all_errors = $errors[0]' \
              final-report/error-summary.json > final-report/error-summary.tmp && mv final-report/error-summary.tmp final-report/error-summary.json
          fi
          
          # Display summary
          echo "=== ERROR SUMMARY ==="
          jq -r '.summary' final-report/error-summary.json
          echo ""
          echo "=== ERRORS BY SEVERITY ==="
          jq -r '.all_errors | group_by(.severity) | map("\(.length) \(.[0].severity) errors") | .[]' final-report/error-summary.json
          echo ""
          echo "=== ERRORS BY CATEGORY ==="
          jq -r '.by_category | to_entries | map("\(.key): \(.value)") | .[]' final-report/error-summary.json
      
      - name: üìÑ Generate Final HTML Report
        run: |
          # Get error data
          TOTAL_ERRORS=$(jq '.summary.total_errors' final-report/error-summary.json)
          CRITICAL_ERRORS=$(jq '.summary.critical' final-report/error-summary.json)
          HIGH_ERRORS=$(jq '.summary.high' final-report/error-summary.json)
          MEDIUM_ERRORS=$(jq '.summary.medium' final-report/error-summary.json)
          
          # Determine overall status
          if [ "$CRITICAL_ERRORS" -gt "0" ]; then
            OVERALL_STATUS="CRITICAL"
            STATUS_COLOR="#f56565"
            STATUS_EMOJI="üö®"
          elif [ "$HIGH_ERRORS" -gt "0" ]; then
            OVERALL_STATUS="WARNING"
            STATUS_COLOR="#ed8936"
            STATUS_EMOJI="‚ö†Ô∏è"
          elif [ "$TOTAL_ERRORS" -gt "0" ]; then
            OVERALL_STATUS="ATTENTION"
            STATUS_COLOR="#ecc94b"
            STATUS_EMOJI="‚ö°"
          else
            OVERALL_STATUS="SUCCESS"
            STATUS_COLOR="#48bb78"
            STATUS_EMOJI="‚úÖ"
          fi
          
          cat > final-report/index.html <<'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ru">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>K8s Test Report - 3XUI | ${{ github.run_id }}</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
                min-height: 100vh;
              }
              .container { 
                max-width: 1400px; 
                margin: 0 auto; 
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                padding: 40px;
              }
              .header {
                text-align: center;
                margin-bottom: 40px;
                padding-bottom: 30px;
                border-bottom: 3px solid #e2e8f0;
              }
              h1 { 
                color: #2d3748; 
                margin-bottom: 10px;
                font-size: 2.5em;
              }
              .subtitle {
                color: #718096;
                font-size: 1.1em;
              }
              .status-banner {
                background: STATUS_COLOR_PLACEHOLDER;
                color: white;
                padding: 20px;
                border-radius: 15px;
                text-align: center;
                font-size: 1.5em;
                font-weight: bold;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
              }
              .metrics {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
              }
              .metric-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
                transition: transform 0.3s;
              }
              .metric-card.critical { background: linear-gradient(135deg, #f56565 0%, #c53030 100%); }
              .metric-card.high { background: linear-gradient(135deg, #ed8936 0%, #c05621 100%); }
              .metric-card.medium { background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%); }
              .metric-card.success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
              .metric-card:hover {
                transform: translateY(-5px);
              }
              .metric-value {
                font-size: 3em;
                font-weight: bold;
                margin: 10px 0;
              }
              .metric-label {
                font-size: 0.9em;
                opacity: 0.9;
                text-transform: uppercase;
                letter-spacing: 1px;
              }
              .section {
                margin: 30px 0;
                padding: 25px;
                background: #f7fafc;
                border-radius: 15px;
                border-left: 5px solid #667eea;
              }
              .section h2 {
                color: #2d3748;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
              }
              .section h2::before {
                content: '‚ñ∂';
                color: #667eea;
                margin-right: 10px;
              }
              .error-item {
                background: white;
                padding: 20px;
                margin: 15px 0;
                border-radius: 12px;
                border-left: 6px solid #f56565;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
              }
              .error-item.critical { border-left-color: #f56565; }
              .error-item.high { border-left-color: #ed8936; }
              .error-item.medium { border-left-color: #ecc94b; }
              .error-item.low { border-left-color: #4299e1; }
              .error-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              }
              .error-category {
                font-weight: bold;
                color: #2d3748;
                font-size: 1.1em;
              }
              .error-badge {
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.85em;
                font-weight: bold;
              }
              .badge.critical { background: #fed7d7; color: #742a2a; }
              .badge.high { background: #feebc8; color: #7c2d12; }
              .badge.medium { background: #fefcbf; color: #744210; }
              .badge.low { background: #bee3f8; color: #2c5282; }
              .error-message {
                color: #4a5568;
                margin: 10px 0;
                line-height: 1.6;
              }
              .error-tool {
                display: inline-block;
                background: #edf2f7;
                padding: 3px 10px;
                border-radius: 8px;
                font-size: 0.85em;
                color: #4a5568;
                margin-right: 10px;
              }
              .error-recommendation {
                background: #e6fffa;
                border-left: 4px solid #38b2ac;
                padding: 15px;
                margin-top: 15px;
                border-radius: 8px;
              }
              .error-recommendation::before {
                content: 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ';
                font-weight: bold;
                color: #2c7a7b;
              }
              .chart-container {
                background: white;
                padding: 30px;
                border-radius: 15px;
                margin: 20px 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
              }
              .chart-title {
                font-size: 1.3em;
                color: #2d3748;
                margin-bottom: 20px;
                font-weight: bold;
              }
              .bar-chart {
                display: flex;
                flex-direction: column;
                gap: 15px;
              }
              .bar-item {
                display: flex;
                align-items: center;
              }
              .bar-label {
                min-width: 150px;
                font-weight: 500;
                color: #4a5568;
              }
              .bar {
                flex: 1;
                height: 30px;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                border-radius: 8px;
                position: relative;
                transition: width 0.3s;
              }
              .bar-value {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: white;
                font-weight: bold;
              }
              pre {
                background: #2d3748;
                color: #e2e8f0;
                padding: 20px;
                border-radius: 8px;
                overflow-x: auto;
                font-size: 0.9em;
                line-height: 1.6;
              }
              .timestamp {
                text-align: center;
                color: #a0aec0;
                margin-top: 40px;
                font-size: 0.9em;
                padding-top: 30px;
                border-top: 2px solid #e2e8f0;
              }
              .quick-links {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                margin: 20px 0;
              }
              .quick-link {
                background: #667eea;
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                text-decoration: none;
                transition: all 0.3s;
                font-weight: 500;
              }
              .quick-link:hover {
                background: #5a67d8;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
              }
              th, td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #e2e8f0;
              }
              th {
                background: #edf2f7;
                font-weight: 600;
                color: #2d3748;
              }
              tr:hover {
                background: #f7fafc;
              }
              .no-errors {
                text-align: center;
                padding: 60px 20px;
                color: #48bb78;
                font-size: 1.5em;
              }
              .no-errors::before {
                content: 'üéâ';
                display: block;
                font-size: 4em;
                margin-bottom: 20px;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>STATUS_EMOJI_PLACEHOLDER Kubernetes Test Report</h1>
                <div class="subtitle">3XUI StatefulSet - Run #${{ github.run_id }}</div>
              </div>
              
              <div class="status-banner">
                STATUS_EMOJI_PLACEHOLDER OVERALL_STATUS_PLACEHOLDER
              </div>
              
              <div class="quick-links">
                <a href="#summary" class="quick-link">üìä Summary</a>
                <a href="#errors" class="quick-link">üö® Errors</a>
                <a href="#charts" class="quick-link">üìà Charts</a>
                <a href="#recommendations" class="quick-link">üí° Recommendations</a>
                <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="quick-link" target="_blank">üîó View Workflow</a>
              </div>
              
              <div id="summary">
                <div class="metrics">
                  <div class="metric-card">
                    <div class="metric-label">Total Errors</div>
                    <div class="metric-value">TOTAL_ERRORS_PLACEHOLDER</div>
                  </div>
                  <div class="metric-card critical">
                    <div class="metric-label">Critical</div>
                    <div class="metric-value">CRITICAL_ERRORS_PLACEHOLDER</div>
                  </div>
                  <div class="metric-card high">
                    <div class="metric-label">High</div>
                    <div class="metric-value">HIGH_ERRORS_PLACEHOLDER</div>
                  </div>
                  <div class="metric-card medium">
                    <div class="metric-label">Medium</div>
                    <div class="metric-value">MEDIUM_ERRORS_PLACEHOLDER</div>
                  </div>
                </div>
              </div>
              
              <div id="charts">
                <div class="chart-container">
                  <div class="chart-title">üìä Errors by Stage</div>
                  <div class="bar-chart" id="stage-chart"></div>
                </div>
                
                <div class="chart-container">
                  <div class="chart-title">üîß Errors by Tool</div>
                  <div class="bar-chart" id="tool-chart"></div>
                </div>
                
                <div class="chart-container">
                  <div class="chart-title">üìã Errors by Category</div>
                  <div class="bar-chart" id="category-chart"></div>
                </div>
              </div>
              
              <div id="errors" class="section">
                <h2>Detailed Error Report</h2>
                <div id="error-list"></div>
              </div>
              
              <div class="timestamp">
                Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC') | Workflow Run: ${{ github.run_id }} | Commit: ${{ github.sha }}
              </div>
            </div>
            
            <script>
              const errorData = ERROR_DATA_PLACEHOLDER;
              
              // Render charts
              function renderChart(containerId, data) {
                const container = document.getElementById(containerId);
                if (!data || Object.keys(data).length === 0) {
                  container.innerHTML = '<p style="text-align:center;color:#a0aec0;">No data available</p>';
                  return;
                }
                
                const max = Math.max(...Object.values(data));
                Object.entries(data).forEach(([key, value]) => {
                  const width = (value / max) * 100;
                  container.innerHTML += `
                    <div class="bar-item">
                      <div class="bar-label">${key}</div>
                      <div class="bar" style="width: ${width}%">
                        <div class="bar-value">${value}</div>
                      </div>
                    </div>
                  `;
                });
              }
              
              renderChart('stage-chart', errorData.by_stage);
              renderChart('tool-chart', errorData.by_tool);
              renderChart('category-chart', errorData.by_category);
              
              // Render errors
              const errorList = document.getElementById('error-list');
              if (errorData.all_errors && errorData.all_errors.length > 0) {
                errorData.all_errors.forEach(error => {
                  errorList.innerHTML += `
                    <div class="error-item ${error.severity.toLowerCase()}">
                      <div class="error-header">
                        <div class="error-category">${error.category}</div>
                        <div class="error-badge badge ${error.severity.toLowerCase()}">${error.severity}</div>
                      </div>
                      <div class="error-tool">üîß ${error.tool}</div>
                      <div class="error-message">${error.message}</div>
                      ${error.recommendation ? `<div class="error-recommendation">${error.recommendation}</div>` : ''}
                    </div>
                  `;
                });
              } else {
                errorList.innerHTML = '<div class="no-errors">–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!</div>';
              }
            </script>
          </body>
          </html>
          HTMLEOF
          
          # Replace placeholders
          sed -i "s/TOTAL_ERRORS_PLACEHOLDER/$TOTAL_ERRORS/g" final-report/index.html
          sed -i "s/CRITICAL_ERRORS_PLACEHOLDER/$CRITICAL_ERRORS/g" final-report/index.html
          sed -i "s/HIGH_ERRORS_PLACEHOLDER/$HIGH_ERRORS/g" final-report/index.html
          sed -i "s/MEDIUM_ERRORS_PLACEHOLDER/$MEDIUM_ERRORS/g" final-report/index.html
          sed -i "s/OVERALL_STATUS_PLACEHOLDER/$OVERALL_STATUS/g" final-report/index.html
          sed -i "s/STATUS_COLOR_PLACEHOLDER/$STATUS_COLOR/g" final-report/index.html
          sed -i "s/STATUS_EMOJI_PLACEHOLDER/$STATUS_EMOJI/g" final-report/index.html
          
          # Inject error data as JavaScript
          ERROR_JSON=$(cat final-report/error-summary.json | jq -c '.')
          sed -i "s|ERROR_DATA_PLACEHOLDER|$ERROR_JSON|g" final-report/index.html
      
      - name: üìù Generate Text Report
        run: |
          cat > final-report/ERRORS.md <<'EOF'
          # üö® Kubernetes Testing Error Report
          
          **Workflow Run:** ${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ---
          
          ## üìä Executive Summary
          
          EOF
          
          # Add summary stats
          jq -r '
          "### Error Counts\n\n" +
          "- **Total Errors:** \(.summary.total_errors)\n" +
          "- **Critical:** \(.summary.critical)\n" +
          "- **High:** \(.summary.high)\n" +
          "- **Medium:** \(.summary.medium)\n" +
          "- **Low:** \(.summary.low)\n\n" +
          "---\n\n" +
          "## üéØ Errors by Category\n\n" +
          (.by_category | to_entries | map("- **\(.key):** \(.value)") | join("\n")) +
          "\n\n---\n\n" +
          "## üìã Errors by Stage\n\n" +
          (.by_stage | to_entries | map("- **\(.key):** \(.value)") | join("\n")) +
          "\n\n---\n\n" +
          "## üîß Errors by Tool\n\n" +
          (.by_tool | to_entries | map("- **\(.key):** \(.value)") | join("\n")) +
          "\n\n---\n\n" +
          "## üö® Detailed Error List\n\n"
          ' final-report/error-summary.json >> final-report/ERRORS.md
          
          # Add detailed errors
          jq -r '
          .all_errors[] |
          "### [\(.severity)] \(.category)\n\n" +
          "- **Tool:** \(.tool)\n" +
          "- **Message:** \(.message)\n" +
          (if .recommendation then "- **Recommendation:** \(.recommendation)\n" else "" end) +
          "\n---\n\n"
          ' final-report/error-summary.json >> final-report/ERRORS.md || echo "No errors found" >> final-report/ERRORS.md
          
          # Display report
          cat final-report/ERRORS.md
      
      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-error-report
          path: final-report/
      
      - name: üí¨ Comment on PR with Error Summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const errorSummary = JSON.parse(fs.readFileSync('final-report/error-summary.json', 'utf8'));
            
            let emoji = '‚úÖ';
            let status = 'SUCCESS';
            if (errorSummary.summary.critical > 0) {
              emoji = 'üö®';
              status = 'CRITICAL';
            } else if (errorSummary.summary.high > 0) {
              emoji = '‚ö†Ô∏è';
              status = 'WARNING';
            } else if (errorSummary.summary.total_errors > 0) {
              emoji = '‚ö°';
              status = 'ATTENTION';
            }
            
            const body = `
            ## ${emoji} Kubernetes Test Report - ${status}
            
            ### üìä Summary
            - **Total Errors:** ${errorSummary.summary.total_errors}
            - **Critical:** ${errorSummary.summary.critical}
            - **High:** ${errorSummary.summary.high}
            - **Medium:** ${errorSummary.summary.medium}
            
            ### üîó Quick Links
            - [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Download Error Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)
            
            ${errorSummary.summary.total_errors > 0 ? `
            ### üö® Top Issues
            ${errorSummary.all_errors.slice(0, 5).map(e => `- **[${e.severity}]** ${e.category}: ${e.message}`).join('\n')}
            
            *See full report artifact for complete details and recommendations.*
            ` : '### üéâ All tests passed successfully!'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: ‚ùå Fail workflow if critical errors found
        if: always()
        run: |
          CRITICAL=$(jq '.summary.critical' final-report/error-summary.json)
          if [ "$CRITICAL" -gt "0" ]; then
            echo "::error::Found $CRITICAL critical errors. Failing workflow."
            exit 1
          fi

  # ==================== FINAL: STATUS NOTIFICATION ====================
  notify-status:
    name: üì¢ Build Status
    runs-on: ubuntu-latest
    needs: [error-aggregation]
    if: always()
    steps:
      - name: Download error report
        uses: actions/download-artifact@v4
        with:
          name: final-error-report
          path: final-report
        continue-on-error: true
      
      - name: Display Final Status
        run: |
          if [ -f "final-report/error-summary.json" ]; then
            TOTAL=$(jq '.summary.total_errors' final-report/error-summary.json)
            CRITICAL=$(jq '.summary.critical' final-report/error-summary.json)
            
            echo "========================================="
            echo "   KUBERNETES TESTING FINAL REPORT"
            echo "========================================="
            echo ""
            jq -r '"Total Errors: \(.summary.total_errors)\nCritical: \(.summary.critical)\nHigh: \(.summary.high)\nMedium: \(.summary.medium)"' final-report/error-summary.json
            echo ""
            echo "========================================="
            
            if [ "$CRITICAL" -gt "0" ]; then
              echo "‚ùå WORKFLOW FAILED - CRITICAL ERRORS FOUND"
              exit 1
            elif [ "$TOTAL" -eq "0" ]; then
              echo "‚úÖ WORKFLOW SUCCESS - NO ERRORS"
            else
              echo "‚ö†Ô∏è WORKFLOW COMPLETED WITH WARNINGS"
            fi
          else
            echo "‚úÖ Workflow completed"
          fi
