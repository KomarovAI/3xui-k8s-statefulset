name: "ðŸ·ï¸ Automated Release & Tagging"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.5.3)'
        required: true
        type: string
      release-type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  validate-version:
    name: 'Validate Version'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          
          # Validate semver format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid version format. Expected: v1.2.3 or v1.2.3-beta.1"
            exit 1
          fi
          
          # Check if tag exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âŒ Tag $VERSION already exists!"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version $VERSION is valid and available"
  
  create-release:
    name: 'Create GitHub Release'
    needs: validate-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "## What's Changed" > changelog.md
          echo "" >> changelog.md
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "### Initial Release" >> changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s (%h)" --no-merges | head -n 50 >> changelog.md
          else
            echo "### Changes since $PREVIOUS_TAG" >> changelog.md
            echo "" >> changelog.md
            
            # Categorize commits
            echo "#### âœ¨ Features" >> changelog.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges --grep="^feat" | sed 's/^/- /' >> changelog.md || echo "- No new features" >> changelog.md
            echo "" >> changelog.md
            
            echo "#### ðŸ› Bug Fixes" >> changelog.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges --grep="^fix" | sed 's/^/- /' >> changelog.md || echo "- No bug fixes" >> changelog.md
            echo "" >> changelog.md
            
            echo "#### ðŸ› ï¸ Improvements" >> changelog.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges --grep="^chore\|^refactor\|^perf" | sed 's/^/- /' >> changelog.md || echo "- No improvements" >> changelog.md
            echo "" >> changelog.md
            
            echo "#### ðŸ“š Documentation" >> changelog.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges --grep="^docs" | sed 's/^/- /' >> changelog.md || echo "- No documentation changes" >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "## ðŸ³ Docker Image" >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`bash" >> changelog.md
          echo "docker pull artur7892988/3xui-k8s-statefulset:$VERSION" >> changelog.md
          echo "docker pull artur7892988/3xui-k8s-statefulset:latest" >> changelog.md
          echo "\`\`\`" >> changelog.md
          echo "" >> changelog.md
          echo "### Multi-arch Support" >> changelog.md
          echo "- âœ… linux/amd64" >> changelog.md
          echo "- âœ… linux/arm64" >> changelog.md
          echo "" >> changelog.md
          echo "## ðŸ’» Kubernetes Deployment" >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`yaml" >> changelog.md
          echo "image: artur7892988/3xui-k8s-statefulset:$VERSION" >> changelog.md
          echo "\`\`\`" >> changelog.md
          echo "" >> changelog.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...$VERSION" >> changelog.md
          fi
          
          cat changelog.md
      
      - name: Create Git tag
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          git tag -a $VERSION -m "Release $VERSION"
          git push origin $VERSION
          echo "âœ… Tag $VERSION created and pushed"
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PRERELEASE="${{ inputs.prerelease }}"
          
          if [ "$PRERELEASE" = "true" ]; then
            gh release create $VERSION \
              --title "Release $VERSION (Pre-release)" \
              --notes-file changelog.md \
              --prerelease
          else
            gh release create $VERSION \
              --title "Release $VERSION" \
              --notes-file changelog.md
          fi
          
          echo "âœ… GitHub Release created: $VERSION"
      
      - name: Generate summary
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          
          echo "# ðŸŽ‰ Release $VERSION Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/artur7892988/3xui-k8s-statefulset/tags)" >> $GITHUB_STEP_SUMMARY
          echo "- [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ³ Docker Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull artur7892988/3xui-k8s-statefulset:$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â±ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Docker image will be published automatically via workflow_6" >> $GITHUB_STEP_SUMMARY
          echo "2. Update production Kubernetes manifests with new version" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor deployment in production cluster" >> $GITHUB_STEP_SUMMARY
