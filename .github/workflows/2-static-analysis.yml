name: "ðŸ“Š Static Analysis & Best Practices"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: static-analysis-${{ github.ref }}
  cancel-in-progress: true

env:
  HADOLINT_VERSION: 2.12.0
  KUBESCORE_VERSION: 1.18.0
  KUBECONFORM_VERSION: 0.6.4
  POLARIS_VERSION: 8.5.0
  CONFTEST_VERSION: 0.49.0

jobs:
  hadolint-lint:
    name: 'Hadolint - Dockerfile Quality'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Hadolint
        uses: actions/cache@v4
        id: cache-hadolint
        with:
          path: /usr/local/bin/hadolint
          key: hadolint-${{ env.HADOLINT_VERSION }}
      
      - name: Install Hadolint
        if: steps.cache-hadolint.outputs.cache-hit != 'true'
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v${{ env.HADOLINT_VERSION }}/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      
      - name: Run Hadolint (JSON for analysis)
        run: |
          hadolint Dockerfile --format json > hadolint-report.json
          cat hadolint-report.json
        continue-on-error: true
      
      - name: Run Hadolint (SARIF for GitHub Security)
        run: |
          hadolint Dockerfile --format sarif > hadolint.sarif
        continue-on-error: true
      
      - name: Run Hadolint (fail on errors)
        run: |
          hadolint Dockerfile --failure-threshold warning
      
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: hadolint.sarif
          category: hadolint
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hadolint-results-${{ github.sha }}
          path: |
            hadolint-report.json
            hadolint.sarif
          retention-days: 30

  kube-score:
    name: 'Kube-Score - K8s Quality'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache kube-score
        uses: actions/cache@v4
        id: cache-kubescore
        with:
          path: /usr/local/bin/kube-score
          key: kubescore-${{ env.KUBESCORE_VERSION }}
      
      - name: Install kube-score
        if: steps.cache-kubescore.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v${{ env.KUBESCORE_VERSION }}/kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          tar -xzf kube-score_${{ env.KUBESCORE_VERSION }}_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/
      
      - name: Run kube-score
        run: |
          if [ -d "manifests" ]; then
            kube-score score manifests/*.yaml --output-format ci | tee kubescore-output.txt
          else
            echo "âš ï¸ No manifests directory found" | tee kubescore-output.txt
          fi
        continue-on-error: true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kubescore-results-${{ github.sha }}
          path: kubescore-output.txt
          retention-days: 30

  kubeconform-validate:
    name: 'Kubeconform - YAML Schema'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Kubeconform
        uses: actions/cache@v4
        id: cache-kubeconform
        with:
          path: /usr/local/bin/kubeconform
          key: kubeconform-${{ env.KUBECONFORM_VERSION }}
      
      - name: Install Kubeconform
        if: steps.cache-kubeconform.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v${{ env.KUBECONFORM_VERSION }}/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          chmod +x kubeconform
          sudo mv kubeconform /usr/local/bin/
      
      - name: Validate manifests
        run: |
          if [ -d "manifests" ]; then
            kubeconform -strict -summary manifests/*.yaml | tee kubeconform-output.txt
          else
            echo "âš ï¸ No manifests directory found" | tee kubeconform-output.txt
          fi
        continue-on-error: true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kubeconform-results-${{ github.sha }}
          path: kubeconform-output.txt
          retention-days: 30

  polaris-score:
    name: 'Polaris - Policy Check'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Polaris
        uses: actions/cache@v4
        id: cache-polaris
        with:
          path: /usr/local/bin/polaris
          key: polaris-${{ env.POLARIS_VERSION }}
      
      - name: Install Polaris
        if: steps.cache-polaris.outputs.cache-hit != 'true'
        run: |
          wget -O- https://github.com/FairwindsOps/polaris/releases/download/${{ env.POLARIS_VERSION }}/polaris_linux_amd64.tar.gz | tar xz
          sudo mv polaris /usr/local/bin/
      
      - name: Run Polaris
        run: |
          if [ -d "manifests" ]; then
            polaris audit --audit-path manifests --format pretty | tee polaris-output.txt
          else
            echo "âš ï¸ No manifests directory found" | tee polaris-output.txt
          fi
        continue-on-error: true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polaris-results-${{ github.sha }}
          path: polaris-output.txt
          retention-days: 30

  conftest-policy:
    name: 'Conftest - OPA Validation'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Conftest
        uses: actions/cache@v4
        id: cache-conftest
        with:
          path: /usr/local/bin/conftest
          key: conftest-${{ env.CONFTEST_VERSION }}
      
      - name: Install Conftest
        if: steps.cache-conftest.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          tar -xzf conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
      
      - name: Run Conftest
        run: |
          if [ -d "policies" ] && [ -d "manifests" ]; then
            conftest test manifests/*.yaml | tee conftest-output.txt
          else
            echo "âš ï¸ No policies or manifests directory found" | tee conftest-output.txt
          fi
        continue-on-error: true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conftest-results-${{ github.sha }}
          path: conftest-output.txt
          retention-days: 30

  static-analysis-summary:
    name: 'ðŸ“Š Static Analysis Summary'
    needs: [hadolint-lint, kube-score, kubeconform-validate, polaris-score, conftest-policy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
      
      - name: Parse Hadolint results
        id: parse
        run: |
          if [ -f "hadolint-results-${{ github.sha }}/hadolint-report.json" ]; then
            ERRORS=$(jq '[.[] | select(.level=="error")] | length' hadolint-results-*/hadolint-report.json 2>/dev/null || echo "0")
            WARNINGS=$(jq '[.[] | select(.level=="warning")] | length' hadolint-results-*/hadolint-report.json 2>/dev/null || echo "0")
          else
            ERRORS="N/A"
            WARNINGS="N/A"
          fi
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
      
      - name: Generate summary
        run: |
          echo "# ðŸ“Š Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          HADOLINT="${{ needs.hadolint-lint.result }}"
          KUBESCORE="${{ needs.kube-score.result }}"
          KUBECONFORM="${{ needs.kubeconform-validate.result }}"
          POLARIS="${{ needs.polaris-score.result }}"
          CONFTEST="${{ needs.conftest-policy.result }}"
          
          [ "$HADOLINT" = "success" ] && echo "| Hadolint | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY || echo "| Hadolint | âš ï¸ WARNINGS |" >> $GITHUB_STEP_SUMMARY
          [ "$KUBESCORE" = "success" ] && echo "| Kube-Score | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY || echo "| Kube-Score | âš ï¸ WARNINGS |" >> $GITHUB_STEP_SUMMARY
          [ "$KUBECONFORM" = "success" ] && echo "| Kubeconform | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY || echo "| Kubeconform | âš ï¸ WARNINGS |" >> $GITHUB_STEP_SUMMARY
          [ "$POLARIS" = "success" ] && echo "| Polaris | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY || echo "| Polaris | âš ï¸ WARNINGS |" >> $GITHUB_STEP_SUMMARY
          [ "$CONFTEST" = "success" ] && echo "| Conftest | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY || echo "| Conftest | âš ï¸ WARNINGS |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Hadolint Findings" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors**: ${{ steps.parse.outputs.errors }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Warnings**: ${{ steps.parse.outputs.warnings }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ Hadolint **blocks on errors**, other tools are advisory." >> $GITHUB_STEP_SUMMARY
